{"nodes":[{"pos":[12,99],"content":"TN068: Performing Transactions with the Microsoft Access 7 ODBC Driver | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"TN068: Performing Transactions with the Microsoft Access 7 ODBC Driver | Microsoft Docs","pos":[0,87]}]},{"content":"TN068: Performing Transactions with the Microsoft Access 7 ODBC Driver","pos":[722,792]},{"pos":[795,1110],"content":"[!NOTE]\n The following technical note has not been updated since it was first included in the online documentation. As a result, some procedures and topics might be out of date or incorrect. For the latest information, it is recommended that you search for the topic of interest in the online documentation index.","leadings":["","> "],"nodes":[{"content":" The following technical note has not been updated since it was first included in the online documentation. As a result, some procedures and topics might be out of date or incorrect. For the latest information, it is recommended that you search for the topic of interest in the online documentation index.","pos":[8,313],"nodes":[{"content":"The following technical note has not been updated since it was first included in the online documentation.","pos":[1,107]},{"content":"As a result, some procedures and topics might be out of date or incorrect.","pos":[108,182]},{"content":"For the latest information, it is recommended that you search for the topic of interest in the online documentation index.","pos":[183,305]}]}]},{"content":"This note describes how to perform transactions when using the MFC ODBC database classes and the Microsoft Access 7.0 ODBC driver included in the Microsoft ODBC Desktop Driver Pack version 3.0.","pos":[1117,1310]},{"content":"Overview","pos":[1319,1327]},{"content":"If your database application performs transactions, you must be careful to call <ph id=\"ph1\">`CDatabase::BeginTrans`</ph> and <ph id=\"ph2\">`CRecordset::Open`</ph> in the correct sequence in your application.","pos":[1331,1502],"source":"If your database application performs transactions, you must be careful to call `CDatabase::BeginTrans` and `CRecordset::Open` in the correct sequence in your application."},{"content":"The Microsoft Access 7.0 driver uses the Microsoft Jet database engine, and Jet requires that your application not begin a transaction on any database that has an open cursor.","pos":[1503,1678]},{"content":"For the MFC ODBC database classes, an open cursor equates to an open <ph id=\"ph1\">`CRecordset`</ph> object.","pos":[1679,1768],"source":" For the MFC ODBC database classes, an open cursor equates to an open `CRecordset` object."},{"content":"If you open a recordset before calling <bpt id=\"p1\">**</bpt>BeginTrans<ept id=\"p1\">**</ept>, you may not see any error messages.","pos":[1775,1865],"source":"If you open a recordset before calling **BeginTrans**, you may not see any error messages."},{"content":"However, any recordset updates your application makes become permanent after calling <ph id=\"ph1\">`CRecordset::Update`</ph>, and the updates will not be rolled back by calling <bpt id=\"p1\">**</bpt>Rollback<ept id=\"p1\">**</ept>.","pos":[1866,2037],"source":" However, any recordset updates your application makes become permanent after calling `CRecordset::Update`, and the updates will not be rolled back by calling **Rollback**."},{"content":"To avoid this problem, you must call <bpt id=\"p1\">**</bpt>BeginTrans<ept id=\"p1\">**</ept> first and then open the recordset.","pos":[2038,2124],"source":" To avoid this problem, you must call **BeginTrans** first and then open the recordset."},{"content":"MFC checks the driver functionality for cursor commit and rollback behavior.","pos":[2131,2207]},{"content":"Class <ph id=\"ph1\">`CDatabase`</ph> provides two member functions, <ph id=\"ph2\">`GetCursorCommitBehavior`</ph> and <ph id=\"ph3\">`GetCursorRollbackBehavior`</ph>, to determine the effect of any transaction on your open <ph id=\"ph4\">`CRecordset`</ph> object.","pos":[2208,2392],"source":" Class `CDatabase` provides two member functions, `GetCursorCommitBehavior` and `GetCursorRollbackBehavior`, to determine the effect of any transaction on your open `CRecordset` object."},{"content":"For the Microsoft Access 7.0 ODBC driver, these member functions return <ph id=\"ph1\">`SQL_CB_CLOSE`</ph> because the Access driver does not support cursor preservation.","pos":[2393,2543],"source":" For the Microsoft Access 7.0 ODBC driver, these member functions return `SQL_CB_CLOSE` because the Access driver does not support cursor preservation."},{"content":"Therefore, you must call <ph id=\"ph1\">`CRecordset::Requery`</ph> following a <bpt id=\"p1\">**</bpt>CommitTrans<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Rollback<ept id=\"p2\">**</ept> operation.","pos":[2544,2645],"source":" Therefore, you must call `CRecordset::Requery` following a **CommitTrans** or **Rollback** operation."},{"content":"When you need to perform multiple transactions one after another, you cannot call <bpt id=\"p1\">**</bpt>Requery<ept id=\"p1\">**</ept> after the first transaction and then start the next one.","pos":[2652,2802],"source":"When you need to perform multiple transactions one after another, you cannot call **Requery** after the first transaction and then start the next one."},{"content":"You must close the recordset before the next call to <bpt id=\"p1\">**</bpt>BeginTrans<ept id=\"p1\">**</ept> in order to satisfy Jet's requirement.","pos":[2803,2909],"source":" You must close the recordset before the next call to **BeginTrans** in order to satisfy Jet's requirement."},{"content":"This technical note describes two methods of handling this situation:","pos":[2910,2979]},{"pos":[2989,3064],"content":"Closing the recordset after each <bpt id=\"p1\">**</bpt>CommitTrans<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Rollback<ept id=\"p2\">**</ept> operation.","source":"Closing the recordset after each **CommitTrans** or **Rollback** operation."},{"pos":[3074,3118],"content":"Using the ODBC API function <bpt id=\"p1\">**</bpt>SQLFreeStmt<ept id=\"p1\">**</ept>.","source":"Using the ODBC API function **SQLFreeStmt**."},{"content":"Closing the Recordset after each CommitTrans or Rollback Operation","pos":[3127,3193]},{"content":"Before starting a transaction, make sure the recordset object is closed.","pos":[3197,3269]},{"content":"After calling <bpt id=\"p1\">**</bpt>BeginTrans<ept id=\"p1\">**</ept>, call the recordset's <bpt id=\"p2\">**</bpt>Open<ept id=\"p2\">**</ept> member function.","pos":[3270,3346],"source":" After calling **BeginTrans**, call the recordset's **Open** member function."},{"content":"Close the recordset immediately after calling <bpt id=\"p1\">**</bpt>CommitTrans<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Rollback<ept id=\"p2\">**</ept>.","pos":[3347,3425],"source":" Close the recordset immediately after calling **CommitTrans** or **Rollback**."},{"content":"Note that repeatedly opening and closing the recordset can slow an application's performance.","pos":[3426,3519]},{"content":"Using SQLFreeStmt","pos":[3528,3545]},{"content":"You can also use the ODBC API function <bpt id=\"p1\">**</bpt>SQLFreeStmt<ept id=\"p1\">**</ept> to explicitly close the cursor after ending a transaction.","pos":[3549,3662],"source":"You can also use the ODBC API function **SQLFreeStmt** to explicitly close the cursor after ending a transaction."},{"content":"To start another transaction, call <bpt id=\"p1\">**</bpt>BeginTrans<ept id=\"p1\">**</ept> followed by <ph id=\"ph1\">`CRecordset::Requery`</ph>.","pos":[3663,3747],"source":" To start another transaction, call **BeginTrans** followed by `CRecordset::Requery`."},{"content":"When calling <bpt id=\"p1\">**</bpt>SQLFreeStmt<ept id=\"p1\">**</ept>, you must specify the recordset's HSTMT as the first parameter and <bpt id=\"p2\">**</bpt>SQL_CLOSE<ept id=\"p2\">**</ept> as the second parameter.","pos":[3748,3882],"source":" When calling **SQLFreeStmt**, you must specify the recordset's HSTMT as the first parameter and **SQL_CLOSE** as the second parameter."},{"content":"This method is faster than closing and opening the recordset at the start of every transaction.","pos":[3883,3978]},{"content":"The following code demonstrates how to implement this technique:","pos":[3979,4043]},{"content":"Another way to implement this technique is to write a new function, <bpt id=\"p1\">**</bpt>RequeryWithBeginTrans<ept id=\"p1\">**</ept>, which you can call to start the next transaction after you commit or rollback the first one.","pos":[4551,4738],"source":"Another way to implement this technique is to write a new function, **RequeryWithBeginTrans**, which you can call to start the next transaction after you commit or rollback the first one."},{"content":"To write such a function, do the following steps:","pos":[4739,4788]},{"pos":[4798,4863],"content":"Copy the code for <bpt id=\"p1\">**</bpt>CRecordset::Requery( )<ept id=\"p1\">**</ept> to the new function.","source":"Copy the code for **CRecordset::Requery( )** to the new function."},{"pos":[4873,4942],"content":"Add the following line immediately after the call to <bpt id=\"p1\">**</bpt>SQLFreeStmt<ept id=\"p1\">**</ept>:","source":"Add the following line immediately after the call to **SQLFreeStmt**:"},{"content":"Now you can call this function between each pair of transactions:","pos":[4985,5050]},{"pos":[5438,5679],"content":"[!NOTE]\n Do not use this technique if you need to change the recordset member variables **m_strFilter** or `m_strSort` between transactions. In that case, you should close the recordset after each **CommitTrans** or **Rollback** operation.","leadings":["","> "],"nodes":[{"content":" Do not use this technique if you need to change the recordset member variables **m_strFilter** or `m_strSort` between transactions. In that case, you should close the recordset after each **CommitTrans** or **Rollback** operation.","pos":[8,239],"nodes":[{"content":"Do not use this technique if you need to change the recordset member variables <bpt id=\"p1\">**</bpt>m_strFilter<ept id=\"p1\">**</ept> or <ph id=\"ph1\">`m_strSort`</ph> between transactions.","pos":[1,132],"source":" Do not use this technique if you need to change the recordset member variables **m_strFilter** or `m_strSort` between transactions."},{"content":"In that case, you should close the recordset after each <bpt id=\"p1\">**</bpt>CommitTrans<ept id=\"p1\">**</ept> or <bpt id=\"p2\">**</bpt>Rollback<ept id=\"p2\">**</ept> operation.","pos":[133,231],"source":" In that case, you should close the recordset after each **CommitTrans** or **Rollback** operation."}]}]},{"content":"See Also","pos":[5688,5696]},{"content":"Technical Notes by Number","pos":[5701,5726]},{"content":"Technical Notes by Category","pos":[5770,5797]}],"content":"---\ntitle: \"TN068: Performing Transactions with the Microsoft Access 7 ODBC Driver | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\nf1_keywords: \n  - \"vc.data.odbc\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"TN068\"\n  - \"transactions, calling BeginTrans\"\n  - \"transactions, Microsoft Access\"\nms.assetid: d3f8f5d9-b118-4194-be36-a1aefb630c45\ncaps.latest.revision: 9\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# TN068: Performing Transactions with the Microsoft Access 7 ODBC Driver\n> [!NOTE]\n>  The following technical note has not been updated since it was first included in the online documentation. As a result, some procedures and topics might be out of date or incorrect. For the latest information, it is recommended that you search for the topic of interest in the online documentation index.  \n  \n This note describes how to perform transactions when using the MFC ODBC database classes and the Microsoft Access 7.0 ODBC driver included in the Microsoft ODBC Desktop Driver Pack version 3.0.  \n  \n## Overview  \n If your database application performs transactions, you must be careful to call `CDatabase::BeginTrans` and `CRecordset::Open` in the correct sequence in your application. The Microsoft Access 7.0 driver uses the Microsoft Jet database engine, and Jet requires that your application not begin a transaction on any database that has an open cursor. For the MFC ODBC database classes, an open cursor equates to an open `CRecordset` object.  \n  \n If you open a recordset before calling **BeginTrans**, you may not see any error messages. However, any recordset updates your application makes become permanent after calling `CRecordset::Update`, and the updates will not be rolled back by calling **Rollback**. To avoid this problem, you must call **BeginTrans** first and then open the recordset.  \n  \n MFC checks the driver functionality for cursor commit and rollback behavior. Class `CDatabase` provides two member functions, `GetCursorCommitBehavior` and `GetCursorRollbackBehavior`, to determine the effect of any transaction on your open `CRecordset` object. For the Microsoft Access 7.0 ODBC driver, these member functions return `SQL_CB_CLOSE` because the Access driver does not support cursor preservation. Therefore, you must call `CRecordset::Requery` following a **CommitTrans** or **Rollback** operation.  \n  \n When you need to perform multiple transactions one after another, you cannot call **Requery** after the first transaction and then start the next one. You must close the recordset before the next call to **BeginTrans** in order to satisfy Jet's requirement. This technical note describes two methods of handling this situation:  \n  \n-   Closing the recordset after each **CommitTrans** or **Rollback** operation.  \n  \n-   Using the ODBC API function **SQLFreeStmt**.  \n  \n## Closing the Recordset after each CommitTrans or Rollback Operation  \n Before starting a transaction, make sure the recordset object is closed. After calling **BeginTrans**, call the recordset's **Open** member function. Close the recordset immediately after calling **CommitTrans** or **Rollback**. Note that repeatedly opening and closing the recordset can slow an application's performance.  \n  \n## Using SQLFreeStmt  \n You can also use the ODBC API function **SQLFreeStmt** to explicitly close the cursor after ending a transaction. To start another transaction, call **BeginTrans** followed by `CRecordset::Requery`. When calling **SQLFreeStmt**, you must specify the recordset's HSTMT as the first parameter and **SQL_CLOSE** as the second parameter. This method is faster than closing and opening the recordset at the start of every transaction. The following code demonstrates how to implement this technique:  \n  \n```  \nCMyDatabase db;  \ndb.Open(\"MYDATASOURCE\");\n\nCMyRecordset rs(&db);\n\n \n// start transaction 1 and   \n// open the recordset  \ndb.BeginTrans();\n\nrs.Open();\n\n \n// manipulate data  \n \n// end transaction 1  \ndb.CommitTrans();\n*// or Rollback()  \n \n// close the cursor  \n::SQLFreeStmt(rs.m_hstmt, SQL_CLOSE);\n\n \n// start transaction 2  \ndb.BeginTrans();\n\n \n// now get the result set  \nrs.Requery();\n\n \n// manipulate data  \n \n// end transaction 2  \ndb.CommitTrans();\n\n \nrs.Close();\n\ndb.Close();\n```  \n  \n Another way to implement this technique is to write a new function, **RequeryWithBeginTrans**, which you can call to start the next transaction after you commit or rollback the first one. To write such a function, do the following steps:  \n  \n1.  Copy the code for **CRecordset::Requery( )** to the new function.  \n  \n2.  Add the following line immediately after the call to **SQLFreeStmt**:  \n  \n `m_pDatabase->BeginTrans( );`  \n  \n Now you can call this function between each pair of transactions:  \n  \n```  \n// start transaction 1 and   \n// open the recordset  \ndb.BeginTrans();\n\nrs.Open();\n\n \n// manipulate data  \n \n// end transaction 1  \ndb.CommitTrans();\n*// or Rollback()  \n \n// close the cursor,\n    start new transaction,  \n// and get the result set  \nrs.RequeryWithBeginTrans();\n\n \n// manipulate data  \n \n// end transaction 2  \ndb.CommitTrans();\n*// or Rollback()  \n```  \n  \n> [!NOTE]\n>  Do not use this technique if you need to change the recordset member variables **m_strFilter** or `m_strSort` between transactions. In that case, you should close the recordset after each **CommitTrans** or **Rollback** operation.  \n  \n## See Also  \n [Technical Notes by Number](../mfc/technical-notes-by-number.md)   \n [Technical Notes by Category](../mfc/technical-notes-by-category.md)\n\n"}