{"nodes":[{"pos":[12,45],"content":"Stack Allocation | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Stack Allocation | Microsoft Docs","pos":[0,33]}]},{"content":"Stack Allocation","pos":[525,541]},{"content":"A function's prolog is responsible for allocating stack space for local variables, saved registers, stack parameters, and register parameters.","pos":[542,684]},{"content":"The parameter area is always at the bottom of the stack (even if alloca is used), so that it will always be adjacent to the return address during any function call.","pos":[691,855]},{"content":"It contains at least four entries, but always enough space to hold all the parameters needed by any function that may be called.","pos":[856,984]},{"content":"Note that space is always allocated for the register parameters, even if the parameters themselves are never homed to the stack; a callee is guaranteed that space has been allocated for all its parameters.","pos":[985,1190]},{"content":"Home addresses are required for the register arguments so a contiguous area is available in case the called function needs to take the address of the argument list (va_list) or an individual argument.","pos":[1191,1391]},{"content":"This area also provides a convenient place to save register arguments during thunk execution and as a debugging option (for example, it makes the arguments easy to find during debugging if they are stored at their home addresses in the prolog code).","pos":[1392,1641]},{"content":"Even if the called function has fewer than 4 parameters, these 4 stack locations are effectively owned by the called function, and may be used by the called function for other purposes besides saving parameter register values.","pos":[1642,1868]},{"content":"Thus the caller may not save information in this region of stack across a function call.","pos":[1870,1958]},{"content":"If space is dynamically allocated (alloca) in a function, then a nonvolatile register must be used as a frame pointer to mark the base of the fixed part of the stack and that register must be saved and initialized in the prolog.","pos":[1965,2193]},{"content":"Note that when alloca is used, calls to the same callee from the same caller may have different home addresses for their register parameters.","pos":[2194,2335]},{"pos":[2342,2585],"content":"The stack will always be maintained 16-byte aligned, except within the prolog (for example, after the return address is pushed), and except where indicated in <bpt id=\"p1\">[</bpt>Function Types<ept id=\"p1\">](../build/function-types.md)</ept> for a certain class of frame functions.","source":"The stack will always be maintained 16-byte aligned, except within the prolog (for example, after the return address is pushed), and except where indicated in [Function Types](../build/function-types.md) for a certain class of frame functions."},{"content":"The following is an example of the stack layout where function A calls a non-leaf function B. Function A's prolog has already allocated space for all the register and stack parameters required by B at the bottom of the stack.","pos":[2592,2817]},{"content":"The call pushes the return address and B's prolog allocates space for its local variables, nonvolatile registers, and the space needed for it to call functions.","pos":[2818,2978]},{"content":"If B uses alloca, the space is allocated between the local variable/nonvolatile register save area and the parameter stack area.","pos":[2979,3107]},{"content":"AMD conversion example","pos":[3116,3138]},{"content":"When the function B calls another function, the return address is pushed just below the home address for RCX.","pos":[3200,3309]},{"content":"See Also","pos":[3318,3326]},{"content":"Stack Usage","pos":[3331,3342]}],"content":"---\ntitle: \"Stack Allocation | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"C++\"\nms.assetid: 098e51f2-eda6-40d0-b149-0b618aa48b47\ncaps.latest.revision: 8\nauthor: \"corob-msft\"\nms.author: \"corob\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Stack Allocation\nA function's prolog is responsible for allocating stack space for local variables, saved registers, stack parameters, and register parameters.  \n  \n The parameter area is always at the bottom of the stack (even if alloca is used), so that it will always be adjacent to the return address during any function call. It contains at least four entries, but always enough space to hold all the parameters needed by any function that may be called. Note that space is always allocated for the register parameters, even if the parameters themselves are never homed to the stack; a callee is guaranteed that space has been allocated for all its parameters. Home addresses are required for the register arguments so a contiguous area is available in case the called function needs to take the address of the argument list (va_list) or an individual argument. This area also provides a convenient place to save register arguments during thunk execution and as a debugging option (for example, it makes the arguments easy to find during debugging if they are stored at their home addresses in the prolog code). Even if the called function has fewer than 4 parameters, these 4 stack locations are effectively owned by the called function, and may be used by the called function for other purposes besides saving parameter register values.  Thus the caller may not save information in this region of stack across a function call.  \n  \n If space is dynamically allocated (alloca) in a function, then a nonvolatile register must be used as a frame pointer to mark the base of the fixed part of the stack and that register must be saved and initialized in the prolog. Note that when alloca is used, calls to the same callee from the same caller may have different home addresses for their register parameters.  \n  \n The stack will always be maintained 16-byte aligned, except within the prolog (for example, after the return address is pushed), and except where indicated in [Function Types](../build/function-types.md) for a certain class of frame functions.  \n  \n The following is an example of the stack layout where function A calls a non-leaf function B. Function A's prolog has already allocated space for all the register and stack parameters required by B at the bottom of the stack. The call pushes the return address and B's prolog allocates space for its local variables, nonvolatile registers, and the space needed for it to call functions. If B uses alloca, the space is allocated between the local variable/nonvolatile register save area and the parameter stack area.  \n  \n ![AMD conversion example](../build/media/vcamd_conv_ex_5.png \"vcAmd_conv_ex_5\")  \n  \n When the function B calls another function, the return address is pushed just below the home address for RCX.  \n  \n## See Also  \n [Stack Usage](../build/stack-usage.md)"}