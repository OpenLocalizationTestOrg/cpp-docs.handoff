{"nodes":[{"pos":[12,61],"content":"Passing OLE DB Conformance Tests | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Passing OLE DB Conformance Tests | Microsoft Docs","pos":[0,49]}]},{"content":"Passing OLE DB Conformance Tests","pos":[712,744]},{"content":"To make providers more consistent, the Data Access SDK provides a set of OLE DB conformance tests.","pos":[745,843]},{"content":"The tests check all aspects of your provider and give you reasonable assurance that your provider functions as expected.","pos":[844,964]},{"content":"You can find the OLE DB conformance tests on the Microsoft Data Access SDK.","pos":[965,1040]},{"content":"This section focuses on things you should do to pass the conformance tests.","pos":[1041,1116]},{"content":"For information about running the OLE DB conformance tests, see the SDK.","pos":[1117,1189]},{"content":"Running the Conformance Tests","pos":[1198,1227]},{"content":"In Visual C++ 6.0, the OLE DB provider templates added a number of hooking functions to allow you to check values and properties.","pos":[1231,1360]},{"content":"Most of these functions were added in response to the conformance tests.","pos":[1361,1433]},{"pos":[1441,1552],"content":"[!NOTE]\n You need to add several validation functions for your provider to pass the OLE DB conformance tests.","leadings":["","> "],"nodes":[{"content":"You need to add several validation functions for your provider to pass the OLE DB conformance tests.","pos":[9,109]}]},{"content":"This provider requires two validation routines.","pos":[1559,1606]},{"content":"The first routine, <ph id=\"ph1\">`CRowsetImpl::ValidateCommandID`</ph>, is part of your rowset class.","pos":[1607,1689],"source":" The first routine, `CRowsetImpl::ValidateCommandID`, is part of your rowset class."},{"content":"It is called during the creation of the rowset by the provider templates.","pos":[1690,1763]},{"content":"The sample uses this routine to tell consumers that it does not support indexes.","pos":[1764,1844]},{"content":"The first call is to <ph id=\"ph1\">`CRowsetImpl::ValidateCommandID`</ph> (note that the provider uses the <bpt id=\"p1\">**</bpt>_RowsetBaseClass<ept id=\"p1\">**</ept> typedef added in the interface map for <ph id=\"ph2\">`CMyProviderRowset`</ph> in <bpt id=\"p2\">[</bpt>Provider Support for Bookmarks<ept id=\"p2\">](../../data/oledb/provider-support-for-bookmarks.md)</ept>, so you do not have to type that long line of template arguments).","pos":[1845,2166],"source":" The first call is to `CRowsetImpl::ValidateCommandID` (note that the provider uses the **_RowsetBaseClass** typedef added in the interface map for `CMyProviderRowset` in [Provider Support for Bookmarks](../../data/oledb/provider-support-for-bookmarks.md), so you do not have to type that long line of template arguments)."},{"content":"Next, return <bpt id=\"p1\">**</bpt>DB_E_NOINDEX<ept id=\"p1\">**</ept> if the index parameter is not <bpt id=\"p2\">**</bpt>NULL<ept id=\"p2\">**</ept> (this indicates the consumer wants to use an index on us).","pos":[2167,2294],"source":" Next, return **DB_E_NOINDEX** if the index parameter is not **NULL** (this indicates the consumer wants to use an index on us)."},{"content":"For more information about command IDs, see the OLE DB specification and look for <bpt id=\"p1\">**</bpt>IOpenRowset::OpenRowset<ept id=\"p1\">**</ept>.","pos":[2295,2405],"source":" For more information about command IDs, see the OLE DB specification and look for **IOpenRowset::OpenRowset**."},{"pos":[2412,2479],"content":"The following code is the <bpt id=\"p1\">**</bpt>ValidateCommandID<ept id=\"p1\">**</ept> validation routine:","source":"The following code is the **ValidateCommandID** validation routine:"},{"content":"The provider templates call the <ph id=\"ph1\">`OnPropertyChanged`</ph> method whenever someone changes a property on the <bpt id=\"p1\">**</bpt>DBPROPSET_ROWSET<ept id=\"p1\">**</ept> group.","pos":[2920,3049],"source":"The provider templates call the `OnPropertyChanged` method whenever someone changes a property on the **DBPROPSET_ROWSET** group."},{"content":"If you want to handle properties for other groups, you add them to the appropriate object (that is, <bpt id=\"p1\">**</bpt>DBPROPSET_SESSION<ept id=\"p1\">**</ept> checks go in the <ph id=\"ph1\">`CMyProviderSession`</ph> class).","pos":[3050,3217],"source":" If you want to handle properties for other groups, you add them to the appropriate object (that is, **DBPROPSET_SESSION** checks go in the `CMyProviderSession` class)."},{"content":"The code first checks to see whether the property is linked to another.","pos":[3224,3295]},{"content":"If the property is being chained, it sets the <bpt id=\"p1\">**</bpt>DBPROP_BOOKMARKS<ept id=\"p1\">**</ept> property to True.","pos":[3296,3380],"source":" If the property is being chained, it sets the **DBPROP_BOOKMARKS** property to True."},{"content":"Appendix C of the OLE DB specification contains information about properties.","pos":[3381,3458]},{"content":"This information also tells you whether the property is chained to another one.","pos":[3459,3538]},{"content":"You might also want to add the <ph id=\"ph1\">`IsValidValue`</ph> routine to your code.","pos":[3545,3612],"source":"You might also want to add the `IsValidValue` routine to your code."},{"content":"The templates call <ph id=\"ph1\">`IsValidValue`</ph> when attempting to set a property.","pos":[3613,3681],"source":" The templates call `IsValidValue` when attempting to set a property."},{"content":"You would override this method if you require additional processing when setting a property value.","pos":[3682,3780]},{"content":"You can have one of these methods for each property set.","pos":[3781,3837]},{"content":"Threading Issues","pos":[3846,3862]},{"content":"By default, the OLE DB Provider Wizard in the ATL OLE DB Provider Wizard generates code for the provider to run in an apartment model.","pos":[3866,4000]},{"content":"If you attempt to run this code with the conformance tests, you initially get failures.","pos":[4001,4088]},{"content":"This is because Ltm.exe, the tool used to run the OLE DB conformance tests, defaults to free threaded.","pos":[4089,4191]},{"content":"The OLE DB Provider Wizard code defaults to apartment model for performance and ease of use.","pos":[4192,4284]},{"content":"To correct this problem, you can either change LTM or change the provider.","pos":[4291,4365]},{"content":"To change LTM to run in apartment threaded mode","pos":[4376,4423]},{"pos":[4433,4499],"content":"On the LTM main menu, click <bpt id=\"p1\">**</bpt>Tools<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Options<ept id=\"p2\">**</ept>.","source":"On the LTM main menu, click **Tools**, and then click **Options**."},{"pos":[4509,4609],"content":"On the <bpt id=\"p1\">**</bpt>General<ept id=\"p1\">**</ept> tab, change the threading model from <bpt id=\"p2\">**</bpt>Free Threaded<ept id=\"p2\">**</ept> to <bpt id=\"p3\">**</bpt>Apartment Threaded<ept id=\"p3\">**</ept>.","source":"On the **General** tab, change the threading model from **Free Threaded** to **Apartment Threaded**."},{"content":"To change your provider to run in free threaded mode:","pos":[4616,4669]},{"pos":[4679,4866],"content":"In your provider project, search for all instances of <ph id=\"ph1\">`CComSingleThreadModel`</ph> and replace it with <ph id=\"ph2\">`CComMultiThreadModel`</ph>, which should be in your data source, session, and rowset headers.","source":"In your provider project, search for all instances of `CComSingleThreadModel` and replace it with `CComMultiThreadModel`, which should be in your data source, session, and rowset headers."},{"pos":[4876,4953],"content":"In your .rgs file, change the threading model from <bpt id=\"p1\">**</bpt>Apartment<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Both<ept id=\"p2\">**</ept>.","source":"In your .rgs file, change the threading model from **Apartment** to **Both**."},{"content":"Follow correct programming rules for free threaded programming (that is, lock on writes).","pos":[4963,5052]},{"content":"See Also","pos":[5061,5069]},{"content":"Advanced Provider Techniques","pos":[5074,5102]}],"content":"---\ntitle: \"Passing OLE DB Conformance Tests | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"testing, OLE DB providers\"\n  - \"testing providers\"\n  - \"conformance testing\"\n  - \"conformance testing [OLE DB]\"\n  - \"OLE DB providers, testing\"\nms.assetid: d1a4f147-2edd-476c-b452-0e6a0ac09891\ncaps.latest.revision: 7\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Passing OLE DB Conformance Tests\nTo make providers more consistent, the Data Access SDK provides a set of OLE DB conformance tests. The tests check all aspects of your provider and give you reasonable assurance that your provider functions as expected. You can find the OLE DB conformance tests on the Microsoft Data Access SDK. This section focuses on things you should do to pass the conformance tests. For information about running the OLE DB conformance tests, see the SDK.  \n  \n## Running the Conformance Tests  \n In Visual C++ 6.0, the OLE DB provider templates added a number of hooking functions to allow you to check values and properties. Most of these functions were added in response to the conformance tests.  \n  \n> [!NOTE]\n>  You need to add several validation functions for your provider to pass the OLE DB conformance tests.  \n  \n This provider requires two validation routines. The first routine, `CRowsetImpl::ValidateCommandID`, is part of your rowset class. It is called during the creation of the rowset by the provider templates. The sample uses this routine to tell consumers that it does not support indexes. The first call is to `CRowsetImpl::ValidateCommandID` (note that the provider uses the **_RowsetBaseClass** typedef added in the interface map for `CMyProviderRowset` in [Provider Support for Bookmarks](../../data/oledb/provider-support-for-bookmarks.md), so you do not have to type that long line of template arguments). Next, return **DB_E_NOINDEX** if the index parameter is not **NULL** (this indicates the consumer wants to use an index on us). For more information about command IDs, see the OLE DB specification and look for **IOpenRowset::OpenRowset**.  \n  \n The following code is the **ValidateCommandID** validation routine:  \n  \n```  \n/////////////////////////////////////////////////////////////////////  \n// MyProviderRS.H  \n// Class: CMyProviderRowset   \n  \nHRESULT ValidateCommandID(DBID* pTableID, DBID* pIndexID)  \n{  \n   HRESULT hr = _RowsetBaseClass::ValidateCommandID(pTableID, pIndexID);  \n   if (hr != S_OK)  \n      return hr;  \n  \n   if (pIndexID != NULL)  \n      return DB_E_NOINDEX;    // Doesn't support indexes  \n  \n   return S_OK;  \n}  \n```  \n  \n The provider templates call the `OnPropertyChanged` method whenever someone changes a property on the **DBPROPSET_ROWSET** group. If you want to handle properties for other groups, you add them to the appropriate object (that is, **DBPROPSET_SESSION** checks go in the `CMyProviderSession` class).  \n  \n The code first checks to see whether the property is linked to another. If the property is being chained, it sets the **DBPROP_BOOKMARKS** property to True. Appendix C of the OLE DB specification contains information about properties. This information also tells you whether the property is chained to another one.  \n  \n You might also want to add the `IsValidValue` routine to your code. The templates call `IsValidValue` when attempting to set a property. You would override this method if you require additional processing when setting a property value. You can have one of these methods for each property set.  \n  \n## Threading Issues  \n By default, the OLE DB Provider Wizard in the ATL OLE DB Provider Wizard generates code for the provider to run in an apartment model. If you attempt to run this code with the conformance tests, you initially get failures. This is because Ltm.exe, the tool used to run the OLE DB conformance tests, defaults to free threaded. The OLE DB Provider Wizard code defaults to apartment model for performance and ease of use.  \n  \n To correct this problem, you can either change LTM or change the provider.  \n  \n#### To change LTM to run in apartment threaded mode  \n  \n1.  On the LTM main menu, click **Tools**, and then click **Options**.  \n  \n2.  On the **General** tab, change the threading model from **Free Threaded** to **Apartment Threaded**.  \n  \n To change your provider to run in free threaded mode:  \n  \n-   In your provider project, search for all instances of `CComSingleThreadModel` and replace it with `CComMultiThreadModel`, which should be in your data source, session, and rowset headers.  \n  \n-   In your .rgs file, change the threading model from **Apartment** to **Both**.  \n  \n-   Follow correct programming rules for free threaded programming (that is, lock on writes).  \n  \n## See Also  \n [Advanced Provider Techniques](../../data/oledb/advanced-provider-techniques.md)"}