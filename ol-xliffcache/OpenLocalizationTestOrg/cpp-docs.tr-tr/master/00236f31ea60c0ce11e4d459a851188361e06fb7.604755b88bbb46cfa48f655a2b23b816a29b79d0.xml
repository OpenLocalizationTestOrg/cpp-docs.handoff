{"nodes":[{"pos":[12,70],"content":"Optimizing Persistence and Initialization | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Optimizing Persistence and Initialization | Microsoft Docs","pos":[0,58]}]},{"content":"Optimizing Persistence and Initialization","pos":[732,773]},{"content":"By default, persistence and initialization in a control are handled by the <ph id=\"ph1\">`DoPropExchange`</ph> member function.","pos":[774,882],"source":"By default, persistence and initialization in a control are handled by the `DoPropExchange` member function."},{"content":"In a typical control, this function contains calls to several <bpt id=\"p1\">**</bpt>PX_<ept id=\"p1\">**</ept> functions (<ph id=\"ph1\">`PX_Color`</ph>, <ph id=\"ph2\">`PX_Font`</ph>, and so on), one for each property.","pos":[883,1021],"source":" In a typical control, this function contains calls to several **PX_** functions (`PX_Color`, `PX_Font`, and so on), one for each property."},{"content":"This approach has the advantage that a single <ph id=\"ph1\">`DoPropExchange`</ph> implementation can be used for initialization, for persistence in binary format, and for persistence in the so-called \"property-bag\" format used by some containers.","pos":[1028,1255],"source":"This approach has the advantage that a single `DoPropExchange` implementation can be used for initialization, for persistence in binary format, and for persistence in the so-called \"property-bag\" format used by some containers."},{"content":"This one function provides all information about the properties and their default values in one convenient place.","pos":[1256,1369]},{"content":"However, this generality comes at the expense of efficiency.","pos":[1376,1436]},{"content":"The <bpt id=\"p1\">**</bpt>PX_<ept id=\"p1\">**</ept> functions get their flexibility through multilayered implementations that are inherently less efficient than more direct, but less flexible, approaches.","pos":[1437,1601],"source":" The **PX_** functions get their flexibility through multilayered implementations that are inherently less efficient than more direct, but less flexible, approaches."},{"content":"Furthermore, if a control passes a default value to a <bpt id=\"p1\">**</bpt>PX_<ept id=\"p1\">**</ept> function, that default value must be provided every time, even in situations when the default value may not necessarily be used.","pos":[1602,1792],"source":" Furthermore, if a control passes a default value to a **PX_** function, that default value must be provided every time, even in situations when the default value may not necessarily be used."},{"content":"If generating the default value is a nontrivial task (for example, when the value is obtained from an ambient property), then extra, unnecessary work is done in cases where the default value is not used.","pos":[1793,1996]},{"content":"You can improve your control's binary persistence performance by overriding your control's <ph id=\"ph1\">`Serialize`</ph> function.","pos":[2003,2115],"source":"You can improve your control's binary persistence performance by overriding your control's `Serialize` function."},{"content":"The default implementation of this member function makes a call to your <ph id=\"ph1\">`DoPropExchange`</ph> function.","pos":[2116,2214],"source":" The default implementation of this member function makes a call to your `DoPropExchange` function."},{"content":"By overriding it, you can provide a more direct implementation for binary persistence.","pos":[2215,2301]},{"content":"For example, consider this <ph id=\"ph1\">`DoPropExchange`</ph> function:","pos":[2302,2355],"source":" For example, consider this `DoPropExchange` function:"},{"pos":[2373,2388],"content":"NVC_MFC_AxOpt#1"},{"pos":[2469,2587],"content":"To improve the performance of this control's binary persistence, you can override the <ph id=\"ph1\">`Serialize`</ph> function as follows:","source":"To improve the performance of this control's binary persistence, you can override the `Serialize` function as follows:"},{"pos":[2605,2620],"content":"NVC_MFC_AxOpt#2"},{"content":"The <ph id=\"ph1\">`dwVersion`</ph> local variable can be used to detect the version of the control's persistent state being loaded or saved.","pos":[2701,2822],"source":"The `dwVersion` local variable can be used to detect the version of the control's persistent state being loaded or saved."},{"content":"You can use this variable instead of calling <bpt id=\"p1\">[</bpt>CPropExchange::GetVersion<ept id=\"p1\">](../mfc/reference/cpropexchange-class.md#cpropexchange__getversion)</ept>.","pos":[2823,2963],"source":" You can use this variable instead of calling [CPropExchange::GetVersion](../mfc/reference/cpropexchange-class.md#cpropexchange__getversion)."},{"pos":[2970,3162],"content":"To save a little space in the persistent format for a <bpt id=\"p1\">**</bpt>BOOL<ept id=\"p1\">**</ept> property (and to keep it compatible with the format produced by <ph id=\"ph1\">`PX_Bool`</ph>), you can store the property as a <bpt id=\"p2\">**</bpt>BYTE<ept id=\"p2\">**</ept>, as follows:","source":"To save a little space in the persistent format for a **BOOL** property (and to keep it compatible with the format produced by `PX_Bool`), you can store the property as a **BYTE**, as follows:"},{"pos":[3180,3195],"content":"NVC_MFC_AxOpt#3"},{"content":"Note that in the load case, a temporary variable is used and then its value is assigned, rather than casting <ph id=\"ph1\">`m_boolProp`</ph> to a <bpt id=\"p1\">**</bpt>BYTE<ept id=\"p1\">**</ept> reference.","pos":[3276,3422],"source":"Note that in the load case, a temporary variable is used and then its value is assigned, rather than casting `m_boolProp` to a **BYTE** reference."},{"content":"The casting technique would result in only one byte of <ph id=\"ph1\">`m_boolProp`</ph> being modified, leaving the remaining bytes uninitialized.","pos":[3423,3549],"source":" The casting technique would result in only one byte of `m_boolProp` being modified, leaving the remaining bytes uninitialized."},{"pos":[3556,3742],"content":"For the same control, you can optimize the control's initialization by overriding <bpt id=\"p1\">[</bpt>COleControl::OnResetState<ept id=\"p1\">](../mfc/reference/colecontrol-class.md#colecontrol__onresetstate)</ept> as follows:","source":"For the same control, you can optimize the control's initialization by overriding [COleControl::OnResetState](../mfc/reference/colecontrol-class.md#colecontrol__onresetstate) as follows:"},{"pos":[3760,3775],"content":"NVC_MFC_AxOpt#4"},{"content":"Although <ph id=\"ph1\">`Serialize`</ph> and <ph id=\"ph2\">`OnResetState`</ph> have been overridden, the <ph id=\"ph3\">`DoPropExchange`</ph> function should be kept intact because it is still used for persistence in the property-bag format.","pos":[3856,4038],"source":"Although `Serialize` and `OnResetState` have been overridden, the `DoPropExchange` function should be kept intact because it is still used for persistence in the property-bag format."},{"content":"It is important to maintain all three of these functions to ensure that the control manages its properties consistently, regardless of which persistence mechanism the container uses.","pos":[4039,4221]},{"content":"See Also","pos":[4230,4238]},{"content":"MFC ActiveX Controls: Optimization","pos":[4243,4277]}],"content":"---\ntitle: \"Optimizing Persistence and Initialization | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"MFC ActiveX controls, optimizing\"\n  - \"performance, ActiveX controls\"\n  - \"optimization, ActiveX controls\"\n  - \"optimizing performance, ActiveX controls\"\nms.assetid: e821e19e-b9eb-49ab-b719-0743420ba80b\ncaps.latest.revision: 10\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Optimizing Persistence and Initialization\nBy default, persistence and initialization in a control are handled by the `DoPropExchange` member function. In a typical control, this function contains calls to several **PX_** functions (`PX_Color`, `PX_Font`, and so on), one for each property.  \n  \n This approach has the advantage that a single `DoPropExchange` implementation can be used for initialization, for persistence in binary format, and for persistence in the so-called \"property-bag\" format used by some containers. This one function provides all information about the properties and their default values in one convenient place.  \n  \n However, this generality comes at the expense of efficiency. The **PX_** functions get their flexibility through multilayered implementations that are inherently less efficient than more direct, but less flexible, approaches. Furthermore, if a control passes a default value to a **PX_** function, that default value must be provided every time, even in situations when the default value may not necessarily be used. If generating the default value is a nontrivial task (for example, when the value is obtained from an ambient property), then extra, unnecessary work is done in cases where the default value is not used.  \n  \n You can improve your control's binary persistence performance by overriding your control's `Serialize` function. The default implementation of this member function makes a call to your `DoPropExchange` function. By overriding it, you can provide a more direct implementation for binary persistence. For example, consider this `DoPropExchange` function:  \n  \n [!code-cpp[NVC_MFC_AxOpt#1](../mfc/codesnippet/cpp/optimizing-persistence-and-initialization_1.cpp)]  \n  \n To improve the performance of this control's binary persistence, you can override the `Serialize` function as follows:  \n  \n [!code-cpp[NVC_MFC_AxOpt#2](../mfc/codesnippet/cpp/optimizing-persistence-and-initialization_2.cpp)]  \n  \n The `dwVersion` local variable can be used to detect the version of the control's persistent state being loaded or saved. You can use this variable instead of calling [CPropExchange::GetVersion](../mfc/reference/cpropexchange-class.md#cpropexchange__getversion).  \n  \n To save a little space in the persistent format for a **BOOL** property (and to keep it compatible with the format produced by `PX_Bool`), you can store the property as a **BYTE**, as follows:  \n  \n [!code-cpp[NVC_MFC_AxOpt#3](../mfc/codesnippet/cpp/optimizing-persistence-and-initialization_3.cpp)]  \n  \n Note that in the load case, a temporary variable is used and then its value is assigned, rather than casting `m_boolProp` to a **BYTE** reference. The casting technique would result in only one byte of `m_boolProp` being modified, leaving the remaining bytes uninitialized.  \n  \n For the same control, you can optimize the control's initialization by overriding [COleControl::OnResetState](../mfc/reference/colecontrol-class.md#colecontrol__onresetstate) as follows:  \n  \n [!code-cpp[NVC_MFC_AxOpt#4](../mfc/codesnippet/cpp/optimizing-persistence-and-initialization_4.cpp)]  \n  \n Although `Serialize` and `OnResetState` have been overridden, the `DoPropExchange` function should be kept intact because it is still used for persistence in the property-bag format. It is important to maintain all three of these functions to ensure that the control manages its properties consistently, regardless of which persistence mechanism the container uses.  \n  \n## See Also  \n [MFC ActiveX Controls: Optimization](../mfc/mfc-activex-controls-optimization.md)\n\n"}