{"nodes":[{"pos":[12,55],"content":"Optimizing Control Drawing | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Optimizing Control Drawing | Microsoft Docs","pos":[0,43]}]},{"content":"Optimizing Control Drawing","pos":[597,623]},{"content":"When a control is instructed to draw itself into a container-supplied device context, it typically selects GDI objects (such as pens, brushes, and fonts) into the device context, performs its drawing operations, and restores the previous GDI objects.","pos":[624,874]},{"content":"If the container has multiple controls that are to be drawn into the same device context, and each control selects the GDI objects it requires, time can be saved if the controls do not individually restore previously selected objects.","pos":[875,1109]},{"content":"After all the controls have been drawn, the container can automatically restore the original objects.","pos":[1110,1211]},{"content":"To detect whether a container supports this technique, a control can call the <bpt id=\"p1\">[</bpt>COleControl::IsOptimizedDraw<ept id=\"p1\">](../mfc/reference/colecontrol-class.md#colecontrol__isoptimizeddraw)</ept> member function.","pos":[1218,1411],"source":"To detect whether a container supports this technique, a control can call the [COleControl::IsOptimizedDraw](../mfc/reference/colecontrol-class.md#colecontrol__isoptimizeddraw) member function."},{"content":"If this function returns <bpt id=\"p1\">**</bpt>TRUE<ept id=\"p1\">**</ept>, the control can skip the normal step of restoring the previously selected objects.","pos":[1412,1529],"source":" If this function returns **TRUE**, the control can skip the normal step of restoring the previously selected objects."},{"pos":[1536,1610],"content":"Consider a control that has the following (unoptimized) <ph id=\"ph1\">`OnDraw`</ph> function:","source":"Consider a control that has the following (unoptimized) `OnDraw` function:"},{"pos":[1628,1644],"content":"NVC_MFC_AxOpt#15"},{"content":"The pen and brush in this example are local variables, meaning their destructors will be called when they go out of scope (when the <ph id=\"ph1\">`OnDraw`</ph> function ends).","pos":[1710,1866],"source":"The pen and brush in this example are local variables, meaning their destructors will be called when they go out of scope (when the `OnDraw` function ends)."},{"content":"The destructors will attempt to delete the corresponding GDI objects.","pos":[1867,1936]},{"content":"But they should not be deleted if you plan to leave them selected into the device context upon returning from <ph id=\"ph1\">`OnDraw`</ph>.","pos":[1937,2056],"source":" But they should not be deleted if you plan to leave them selected into the device context upon returning from `OnDraw`."},{"content":"To prevent the <bpt id=\"p1\">[</bpt>CPen<ept id=\"p1\">](../mfc/reference/cpen-class.md)</ept> and <bpt id=\"p2\">[</bpt>CBrush<ept id=\"p2\">](../mfc/reference/cbrush-class.md)</ept> objects from being destroyed when <ph id=\"ph1\">`OnDraw`</ph> finishes, store them in member variables instead of local variables.","pos":[2063,2275],"source":"To prevent the [CPen](../mfc/reference/cpen-class.md) and [CBrush](../mfc/reference/cbrush-class.md) objects from being destroyed when `OnDraw` finishes, store them in member variables instead of local variables."},{"content":"In the control's class declaration, add declarations for two new member variables:","pos":[2276,2358]},{"content":"NVC_MFC_AxOpt#16","pos":[2376,2392]},{"content":"NVC_MFC_AxOpt#17","pos":[2463,2479]},{"pos":[2543,2599],"content":"Then, the <ph id=\"ph1\">`OnDraw`</ph> function can be rewritten as follows:","source":"Then, the `OnDraw` function can be rewritten as follows:"},{"pos":[2617,2633],"content":"NVC_MFC_AxOpt#18"},{"content":"This approach avoids creation of the pen and brush every time <ph id=\"ph1\">`OnDraw`</ph> is called.","pos":[2699,2780],"source":"This approach avoids creation of the pen and brush every time `OnDraw` is called."},{"content":"The speed improvement comes at the cost of maintaining additional instance data.","pos":[2781,2861]},{"content":"If the ForeColor or BackColor property changes, the pen or brush needs to be created again.","pos":[2868,2959]},{"content":"To do this, override the <bpt id=\"p1\">[</bpt>OnForeColorChanged<ept id=\"p1\">](../mfc/reference/colecontrol-class.md#colecontrol__onforecolorchanged)</ept> and <bpt id=\"p2\">[</bpt>OnBackColorChanged<ept id=\"p2\">](../mfc/reference/colecontrol-class.md#colecontrol__onbackcolorchanged)</ept> member functions:","pos":[2960,3190],"source":" To do this, override the [OnForeColorChanged](../mfc/reference/colecontrol-class.md#colecontrol__onforecolorchanged) and [OnBackColorChanged](../mfc/reference/colecontrol-class.md#colecontrol__onbackcolorchanged) member functions:"},{"pos":[3208,3224],"content":"NVC_MFC_AxOpt#19"},{"pos":[3290,3373],"content":"Finally, to eliminate unnecessary <ph id=\"ph1\">`SelectObject`</ph> calls, modify <ph id=\"ph2\">`OnDraw`</ph> as follows:","source":"Finally, to eliminate unnecessary `SelectObject` calls, modify `OnDraw` as follows:"},{"pos":[3391,3407],"content":"NVC_MFC_AxOpt#20"},{"content":"See Also","pos":[3475,3483]},{"content":"MFC ActiveX Controls: Optimization","pos":[3488,3522]},{"content":"COleControl Class","pos":[3574,3591]},{"content":"MFC ActiveX Controls","pos":[3637,3657]},{"content":"MFC ActiveX Controls","pos":[3696,3716]},{"content":"MFC ActiveX Control Wizard","pos":[3755,3781]},{"content":"MFC ActiveX Controls: Painting an ActiveX Control","pos":[3836,3885]}],"content":"---\ntitle: \"Optimizing Control Drawing | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"MFC ActiveX controls, optimizing\"\nms.assetid: 29ff985d-9bf5-4678-b62d-aad12def75fb\ncaps.latest.revision: 11\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Optimizing Control Drawing\nWhen a control is instructed to draw itself into a container-supplied device context, it typically selects GDI objects (such as pens, brushes, and fonts) into the device context, performs its drawing operations, and restores the previous GDI objects. If the container has multiple controls that are to be drawn into the same device context, and each control selects the GDI objects it requires, time can be saved if the controls do not individually restore previously selected objects. After all the controls have been drawn, the container can automatically restore the original objects.  \n  \n To detect whether a container supports this technique, a control can call the [COleControl::IsOptimizedDraw](../mfc/reference/colecontrol-class.md#colecontrol__isoptimizeddraw) member function. If this function returns **TRUE**, the control can skip the normal step of restoring the previously selected objects.  \n  \n Consider a control that has the following (unoptimized) `OnDraw` function:  \n  \n [!code-cpp[NVC_MFC_AxOpt#15](../mfc/codesnippet/cpp/optimizing-control-drawing_1.cpp)]  \n  \n The pen and brush in this example are local variables, meaning their destructors will be called when they go out of scope (when the `OnDraw` function ends). The destructors will attempt to delete the corresponding GDI objects. But they should not be deleted if you plan to leave them selected into the device context upon returning from `OnDraw`.  \n  \n To prevent the [CPen](../mfc/reference/cpen-class.md) and [CBrush](../mfc/reference/cbrush-class.md) objects from being destroyed when `OnDraw` finishes, store them in member variables instead of local variables. In the control's class declaration, add declarations for two new member variables:  \n  \n [!code-cpp[NVC_MFC_AxOpt#16](../mfc/codesnippet/cpp/optimizing-control-drawing_2.h)]  \n[!code-cpp[NVC_MFC_AxOpt#17](../mfc/codesnippet/cpp/optimizing-control-drawing_3.h)]  \n  \n Then, the `OnDraw` function can be rewritten as follows:  \n  \n [!code-cpp[NVC_MFC_AxOpt#18](../mfc/codesnippet/cpp/optimizing-control-drawing_4.cpp)]  \n  \n This approach avoids creation of the pen and brush every time `OnDraw` is called. The speed improvement comes at the cost of maintaining additional instance data.  \n  \n If the ForeColor or BackColor property changes, the pen or brush needs to be created again. To do this, override the [OnForeColorChanged](../mfc/reference/colecontrol-class.md#colecontrol__onforecolorchanged) and [OnBackColorChanged](../mfc/reference/colecontrol-class.md#colecontrol__onbackcolorchanged) member functions:  \n  \n [!code-cpp[NVC_MFC_AxOpt#19](../mfc/codesnippet/cpp/optimizing-control-drawing_5.cpp)]  \n  \n Finally, to eliminate unnecessary `SelectObject` calls, modify `OnDraw` as follows:  \n  \n [!code-cpp[NVC_MFC_AxOpt#20](../mfc/codesnippet/cpp/optimizing-control-drawing_6.cpp)]  \n  \n## See Also  \n [MFC ActiveX Controls: Optimization](../mfc/mfc-activex-controls-optimization.md)   \n [COleControl Class](../mfc/reference/colecontrol-class.md)   \n [MFC ActiveX Controls](../mfc/mfc-activex-controls.md)   \n [MFC ActiveX Controls](../mfc/mfc-activex-controls.md)   \n [MFC ActiveX Control Wizard](../mfc/reference/mfc-activex-control-wizard.md)   \n [MFC ActiveX Controls: Painting an ActiveX Control](../mfc/mfc-activex-controls-painting-an-activex-control.md)\n\n"}