{"nodes":[{"pos":[12,88],"content":"Implementation of a Custom String Manager (Advanced Method) | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Implementation of a Custom String Manager (Advanced Method) | Microsoft Docs","pos":[0,76]}]},{"content":"Implementation of a Custom String Manager (Advanced Method)","pos":[626,685]},{"content":"In specialized situations, you might want to implement a custom string manager that does more than just change which heap is used to allocate memory.","pos":[686,835]},{"content":"In this situation, you must manually implement the <bpt id=\"p1\">[</bpt>IAtlStringMgr<ept id=\"p1\">](../atl-mfc-shared/reference/iatlstringmgr-class.md)</ept> interface as your custom string manager.","pos":[836,995],"source":" In this situation, you must manually implement the [IAtlStringMgr](../atl-mfc-shared/reference/iatlstringmgr-class.md) interface as your custom string manager."},{"content":"In order to do this, it is important to first understand how <bpt id=\"p1\">[</bpt>CStringT<ept id=\"p1\">](../atl-mfc-shared/reference/cstringt-class.md)</ept> uses that interface to manage its string data.","pos":[1002,1167],"source":"In order to do this, it is important to first understand how [CStringT](../atl-mfc-shared/reference/cstringt-class.md) uses that interface to manage its string data."},{"content":"Every instance of <ph id=\"ph1\">`CStringT`</ph> has a pointer to a <bpt id=\"p1\">[</bpt>CStringData<ept id=\"p1\">](../atl-mfc-shared/reference/cstringdata-class.md)</ept> structure.","pos":[1168,1290],"source":" Every instance of `CStringT` has a pointer to a [CStringData](../atl-mfc-shared/reference/cstringdata-class.md) structure."},{"content":"This variable-length structure contains important information about the string (such as length), as well as the actual character data for the string.","pos":[1291,1440]},{"content":"Every custom string manager is responsible for allocating and freeing these structures at the request of <ph id=\"ph1\">`CStringT`</ph>.","pos":[1441,1557],"source":" Every custom string manager is responsible for allocating and freeing these structures at the request of `CStringT`."},{"pos":[1564,1614],"content":"The <ph id=\"ph1\">`CStringData`</ph> structure comprises four fields:","source":"The `CStringData` structure comprises four fields:"},{"content":"<bpt id=\"p1\">[</bpt>pStringMgr<ept id=\"p1\">](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__pstringmgr)</ept> This field points to the <ph id=\"ph1\">`IAtlStringMgr`</ph> interface used to manage this string data.","pos":[1624,1794],"source":"[pStringMgr](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__pstringmgr) This field points to the `IAtlStringMgr` interface used to manage this string data."},{"content":"When <ph id=\"ph1\">`CStringT`</ph> needs to reallocate or free the string buffer it calls the Reallocate or Free methods of this interface, passing the <ph id=\"ph2\">`CStringData`</ph> structure as a parameter.","pos":[1795,1967],"source":" When `CStringT` needs to reallocate or free the string buffer it calls the Reallocate or Free methods of this interface, passing the `CStringData` structure as a parameter."},{"content":"When allocating a <ph id=\"ph1\">`CStringData`</ph> structure in your string manager, you must set this field to point to your custom string manager.","pos":[1968,2097],"source":" When allocating a `CStringData` structure in your string manager, you must set this field to point to your custom string manager."},{"content":"<bpt id=\"p1\">[</bpt>nDataLength<ept id=\"p1\">](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__ndatalength)</ept> This field contains the current logical length of the string stored in the buffer excluding the terminating null.","pos":[2107,2309],"source":"[nDataLength](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__ndatalength) This field contains the current logical length of the string stored in the buffer excluding the terminating null."},{"content":"updates this field when the length of the string changes.","pos":[2321,2378]},{"content":"When allocating a <ph id=\"ph1\">`CStringData`</ph> structure, your string manager must set this field to zero.","pos":[2379,2470],"source":" When allocating a `CStringData` structure, your string manager must set this field to zero."},{"content":"When reallocating a <ph id=\"ph1\">`CStringData`</ph> structure, your custom string manager must leave this field unchanged.","pos":[2471,2575],"source":" When reallocating a `CStringData` structure, your custom string manager must leave this field unchanged."},{"content":"<bpt id=\"p1\">[</bpt>nAllocLength<ept id=\"p1\">](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__nalloclength)</ept> This field contains the maximum number of characters (excluding the terminating null) that can be stored in this string buffer without reallocating it.","pos":[2585,2827],"source":"[nAllocLength](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__nalloclength) This field contains the maximum number of characters (excluding the terminating null) that can be stored in this string buffer without reallocating it."},{"content":"Whenever <ph id=\"ph1\">`CStringT`</ph> needs to increase the logical length of the string, it first checks this field to make sure there is enough space in the buffer.","pos":[2828,2976],"source":" Whenever `CStringT` needs to increase the logical length of the string, it first checks this field to make sure there is enough space in the buffer."},{"content":"If the check fails, <ph id=\"ph1\">`CStringT`</ph> calls into your custom string manager to reallocate the buffer.","pos":[2977,3071],"source":" If the check fails, `CStringT` calls into your custom string manager to reallocate the buffer."},{"content":"When allocating or reallocating a <ph id=\"ph1\">`CStringData`</ph> structure, you must set this field to at least the number of characters requested in the <bpt id=\"p1\">**</bpt>nChars<ept id=\"p1\">**</ept> parameter to <bpt id=\"p2\">[</bpt>IAtlStringMgr::Allocate<ept id=\"p2\">](../atl-mfc-shared/reference/iatlstringmgr-class.md#iatlstringmgr__allocate)</ept> or <bpt id=\"p3\">[</bpt>IAtlStringMgr::Reallocate<ept id=\"p3\">](../atl-mfc-shared/reference/iatlstringmgr-class.md#iatlstringmgr__reallocate)</ept>.","pos":[3072,3444],"source":" When allocating or reallocating a `CStringData` structure, you must set this field to at least the number of characters requested in the **nChars** parameter to [IAtlStringMgr::Allocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#iatlstringmgr__allocate) or [IAtlStringMgr::Reallocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#iatlstringmgr__reallocate)."},{"content":"If there is more space in the buffer than requested, you can set this value to reflect the actual amount of space available.","pos":[3445,3569]},{"content":"This allows <ph id=\"ph1\">`CStringT`</ph> to grow the string to fill the entire allocated space before it has to call back into the string manager to reallocate the buffer.","pos":[3570,3723],"source":" This allows `CStringT` to grow the string to fill the entire allocated space before it has to call back into the string manager to reallocate the buffer."},{"content":"<bpt id=\"p1\">[</bpt>nRefs<ept id=\"p1\">](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__nrefs)</ept> This field contains the current reference count of the string buffer.","pos":[3733,3879],"source":"[nRefs](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__nrefs) This field contains the current reference count of the string buffer."},{"content":"If the value is one, then a single instance of <ph id=\"ph1\">`CStringT`</ph> is using the buffer.","pos":[3880,3958],"source":" If the value is one, then a single instance of `CStringT` is using the buffer."},{"content":"In addition, the instance is allowed to both read and modify the contents of the buffer.","pos":[3959,4047]},{"content":"If the value is greater than one, multiple instances of <ph id=\"ph1\">`CStringT`</ph> can use the buffer.","pos":[4048,4134],"source":" If the value is greater than one, multiple instances of `CStringT` can use the buffer."},{"content":"Because the character buffer is shared, <ph id=\"ph1\">`CStringT`</ph> instances can only read the contents of the buffer.","pos":[4135,4237],"source":" Because the character buffer is shared, `CStringT` instances can only read the contents of the buffer."},{"content":"To modify the contents, <ph id=\"ph1\">`CStringT`</ph> first makes a copy of the buffer.","pos":[4238,4306],"source":" To modify the contents, `CStringT` first makes a copy of the buffer."},{"content":"If the value is negative, only one instance of <ph id=\"ph1\">`CStringT`</ph> is using the buffer.","pos":[4307,4385],"source":" If the value is negative, only one instance of `CStringT` is using the buffer."},{"content":"In this case, the buffer is considered locked.","pos":[4386,4432]},{"content":"When a <ph id=\"ph1\">`CStringT`</ph> instance is using a locked buffer no other instances of <ph id=\"ph2\">`CStringT`</ph> may share the buffer.","pos":[4433,4539],"source":" When a `CStringT` instance is using a locked buffer no other instances of `CStringT` may share the buffer."},{"content":"Instead, these instances create a copy of the buffer before manipulating the contents.","pos":[4540,4626]},{"content":"In addition, the <ph id=\"ph1\">`CStringT`</ph> instance using the locked buffer does not attempt to share the buffer of any other <ph id=\"ph2\">`CStringT`</ph> instance assigned to it.","pos":[4627,4773],"source":" In addition, the `CStringT` instance using the locked buffer does not attempt to share the buffer of any other `CStringT` instance assigned to it."},{"content":"In this case, the <ph id=\"ph1\">`CStringT`</ph> instance copies the other string into the locked buffer.","pos":[4774,4859],"source":" In this case, the `CStringT` instance copies the other string into the locked buffer."},{"content":"When allocating a <ph id=\"ph1\">`CStringData`</ph> structure, you must set this field to reflect the type of sharing that is allowed for the buffer.","pos":[4870,4999],"source":"When allocating a `CStringData` structure, you must set this field to reflect the type of sharing that is allowed for the buffer."},{"content":"For most implementations, set this value to one.","pos":[5000,5048]},{"content":"This allows the usual copy-on-write sharing behavior.","pos":[5049,5102]},{"content":"However, if your string manager does not support sharing the string buffer, set this field to a locked state.","pos":[5103,5212]},{"content":"This forces <ph id=\"ph1\">`CStringT`</ph> to only use this buffer for the instance of <ph id=\"ph2\">`CStringT`</ph> that allocated it.","pos":[5213,5309],"source":" This forces `CStringT` to only use this buffer for the instance of `CStringT` that allocated it."},{"content":"See Also","pos":[5318,5326]},{"content":"Memory Management with CStringT","pos":[5331,5362]}],"content":"---\ntitle: \"Implementation of a Custom String Manager (Advanced Method) | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"reference\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"IAtlStringMgr class, using\"\nms.assetid: 64ab7da9-47c1-4c4a-9cd7-4cc37e7f3f57\ncaps.latest.revision: 10\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Implementation of a Custom String Manager (Advanced Method)\nIn specialized situations, you might want to implement a custom string manager that does more than just change which heap is used to allocate memory. In this situation, you must manually implement the [IAtlStringMgr](../atl-mfc-shared/reference/iatlstringmgr-class.md) interface as your custom string manager.  \n  \n In order to do this, it is important to first understand how [CStringT](../atl-mfc-shared/reference/cstringt-class.md) uses that interface to manage its string data. Every instance of `CStringT` has a pointer to a [CStringData](../atl-mfc-shared/reference/cstringdata-class.md) structure. This variable-length structure contains important information about the string (such as length), as well as the actual character data for the string. Every custom string manager is responsible for allocating and freeing these structures at the request of `CStringT`.  \n  \n The `CStringData` structure comprises four fields:  \n  \n-   [pStringMgr](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__pstringmgr) This field points to the `IAtlStringMgr` interface used to manage this string data. When `CStringT` needs to reallocate or free the string buffer it calls the Reallocate or Free methods of this interface, passing the `CStringData` structure as a parameter. When allocating a `CStringData` structure in your string manager, you must set this field to point to your custom string manager.  \n  \n-   [nDataLength](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__ndatalength) This field contains the current logical length of the string stored in the buffer excluding the terminating null. `CStringT` updates this field when the length of the string changes. When allocating a `CStringData` structure, your string manager must set this field to zero. When reallocating a `CStringData` structure, your custom string manager must leave this field unchanged.  \n  \n-   [nAllocLength](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__nalloclength) This field contains the maximum number of characters (excluding the terminating null) that can be stored in this string buffer without reallocating it. Whenever `CStringT` needs to increase the logical length of the string, it first checks this field to make sure there is enough space in the buffer. If the check fails, `CStringT` calls into your custom string manager to reallocate the buffer. When allocating or reallocating a `CStringData` structure, you must set this field to at least the number of characters requested in the **nChars** parameter to [IAtlStringMgr::Allocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#iatlstringmgr__allocate) or [IAtlStringMgr::Reallocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#iatlstringmgr__reallocate). If there is more space in the buffer than requested, you can set this value to reflect the actual amount of space available. This allows `CStringT` to grow the string to fill the entire allocated space before it has to call back into the string manager to reallocate the buffer.  \n  \n-   [nRefs](../atl-mfc-shared/reference/cstringdata-class.md#cstringdata__nrefs) This field contains the current reference count of the string buffer. If the value is one, then a single instance of `CStringT` is using the buffer. In addition, the instance is allowed to both read and modify the contents of the buffer. If the value is greater than one, multiple instances of `CStringT` can use the buffer. Because the character buffer is shared, `CStringT` instances can only read the contents of the buffer. To modify the contents, `CStringT` first makes a copy of the buffer. If the value is negative, only one instance of `CStringT` is using the buffer. In this case, the buffer is considered locked. When a `CStringT` instance is using a locked buffer no other instances of `CStringT` may share the buffer. Instead, these instances create a copy of the buffer before manipulating the contents. In addition, the `CStringT` instance using the locked buffer does not attempt to share the buffer of any other `CStringT` instance assigned to it. In this case, the `CStringT` instance copies the other string into the locked buffer.  \n  \n     When allocating a `CStringData` structure, you must set this field to reflect the type of sharing that is allowed for the buffer. For most implementations, set this value to one. This allows the usual copy-on-write sharing behavior. However, if your string manager does not support sharing the string buffer, set this field to a locked state. This forces `CStringT` to only use this buffer for the instance of `CStringT` that allocated it.  \n  \n## See Also  \n [Memory Management with CStringT](../atl-mfc-shared/memory-management-with-cstringt.md)\n\n"}