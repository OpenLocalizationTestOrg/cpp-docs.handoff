{"nodes":[{"pos":[12,71],"content":"Automation Servers: Object-Lifetime Issues | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Automation Servers: Object-Lifetime Issues | Microsoft Docs","pos":[0,59]}]},{"content":"Automation Servers: Object-Lifetime Issues","pos":[718,760]},{"content":"When an Automation client creates or activates an OLE item, the server passes the client a pointer to that object.","pos":[761,875]},{"content":"The client establishes a reference to the object through a call to the OLE function <bpt id=\"p1\">[</bpt>IUnknown::AddRef<ept id=\"p1\">](http://msdn.microsoft.com/library/windows/desktop/ms691379)</ept>.","pos":[876,1039],"source":" The client establishes a reference to the object through a call to the OLE function [IUnknown::AddRef](http://msdn.microsoft.com/library/windows/desktop/ms691379)."},{"content":"This reference is in effect until the client calls <bpt id=\"p1\">[</bpt>IUnknown::Release<ept id=\"p1\">](http://msdn.microsoft.com/library/windows/desktop/ms682317)</ept>.","pos":[1040,1171],"source":" This reference is in effect until the client calls [IUnknown::Release](http://msdn.microsoft.com/library/windows/desktop/ms682317)."},{"content":"(Client applications written with the Microsoft Foundation Class Library's OLE classes need not make these calls; the framework does so.) The OLE system and the server itself may establish references to the object.","pos":[1172,1386]},{"content":"A server should not destroy an object as long as external references to the object remain in effect.","pos":[1387,1487]},{"content":"The framework maintains an internal count of the number of references to any server object derived from <bpt id=\"p1\">[</bpt>CCmdTarget<ept id=\"p1\">](../mfc/reference/ccmdtarget-class.md)</ept>.","pos":[1494,1649],"source":"The framework maintains an internal count of the number of references to any server object derived from [CCmdTarget](../mfc/reference/ccmdtarget-class.md)."},{"content":"This count is updated when an Automation client or other entity adds or releases a reference to the object.","pos":[1650,1757]},{"content":"When the reference count becomes 0, the framework calls the virtual function <bpt id=\"p1\">[</bpt>CCmdTarget::OnFinalRelease<ept id=\"p1\">](../mfc/reference/ccmdtarget-class.md#ccmdtarget__onfinalrelease)</ept>.","pos":[1764,1935],"source":"When the reference count becomes 0, the framework calls the virtual function [CCmdTarget::OnFinalRelease](../mfc/reference/ccmdtarget-class.md#ccmdtarget__onfinalrelease)."},{"content":"The default implementation of this function calls the <bpt id=\"p1\">**</bpt>delete<ept id=\"p1\">**</ept> operator to delete this object.","pos":[1936,2032],"source":" The default implementation of this function calls the **delete** operator to delete this object."},{"content":"The Microsoft Foundation Class Library provides additional facilities for controlling application behavior when external clients have references to the application's objects.","pos":[2039,2213]},{"content":"Besides maintaining a count of references to each object, servers maintain a global count of active objects.","pos":[2214,2322]},{"content":"The global functions <bpt id=\"p1\">[</bpt>AfxOleLockApp<ept id=\"p1\">](../mfc/reference/application-control.md#afxolelockapp)</ept> and <bpt id=\"p2\">[</bpt>AfxOleUnlockApp<ept id=\"p2\">](../mfc/reference/application-control.md#afxoleunlockapp)</ept> update the application's count of active objects.","pos":[2323,2543],"source":" The global functions [AfxOleLockApp](../mfc/reference/application-control.md#afxolelockapp) and [AfxOleUnlockApp](../mfc/reference/application-control.md#afxoleunlockapp) update the application's count of active objects."},{"content":"If this count is nonzero, the application does not terminate when the user chooses Close from the system menu or Exit from the File menu.","pos":[2544,2681]},{"content":"Instead, the application's main window is hidden (but not destroyed) until all pending client requests have been completed.","pos":[2682,2805]},{"content":"Typically, <ph id=\"ph1\">`AfxOleLockApp`</ph> and <ph id=\"ph2\">`AfxOleUnlockApp`</ph> are called in the constructors and destructors, respectively, of classes that support Automation.","pos":[2806,2952],"source":" Typically, `AfxOleLockApp` and `AfxOleUnlockApp` are called in the constructors and destructors, respectively, of classes that support Automation."},{"content":"Sometimes circumstances force the server to terminate while a client still has a reference to an object.","pos":[2959,3063]},{"content":"For example, a resource on which the server depends may become unavailable, causing the server to encounter an error.","pos":[3064,3181]},{"content":"The user may also close a server document that contains objects to which other applications have references.","pos":[3182,3290]},{"pos":[3297,3401],"content":"In the <ph id=\"ph1\">[!INCLUDE[winSDK](../atl/includes/winsdk_md.md)]</ph>, see <ph id=\"ph2\">`IUnknown::AddRef`</ph> and <ph id=\"ph3\">`IUnknown::Release`</ph>.","source":"In the [!INCLUDE[winSDK](../atl/includes/winsdk_md.md)], see `IUnknown::AddRef` and `IUnknown::Release`."},{"content":"See Also","pos":[3410,3418]},{"content":"Automation Servers","pos":[3423,3441]},{"content":"AfxOleCanExitApp","pos":[3478,3494]}],"content":"---\ntitle: \"Automation Servers: Object-Lifetime Issues | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"objects [C++], lifetime\"\n  - \"lifetime, automation server\"\n  - \"Automation servers, object lifetime\"\n  - \"servers, lifetime of Automation\"\nms.assetid: 342baacf-4015-4a0e-be2f-321424f1cb43\ncaps.latest.revision: 11\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Automation Servers: Object-Lifetime Issues\nWhen an Automation client creates or activates an OLE item, the server passes the client a pointer to that object. The client establishes a reference to the object through a call to the OLE function [IUnknown::AddRef](http://msdn.microsoft.com/library/windows/desktop/ms691379). This reference is in effect until the client calls [IUnknown::Release](http://msdn.microsoft.com/library/windows/desktop/ms682317). (Client applications written with the Microsoft Foundation Class Library's OLE classes need not make these calls; the framework does so.) The OLE system and the server itself may establish references to the object. A server should not destroy an object as long as external references to the object remain in effect.  \n  \n The framework maintains an internal count of the number of references to any server object derived from [CCmdTarget](../mfc/reference/ccmdtarget-class.md). This count is updated when an Automation client or other entity adds or releases a reference to the object.  \n  \n When the reference count becomes 0, the framework calls the virtual function [CCmdTarget::OnFinalRelease](../mfc/reference/ccmdtarget-class.md#ccmdtarget__onfinalrelease). The default implementation of this function calls the **delete** operator to delete this object.  \n  \n The Microsoft Foundation Class Library provides additional facilities for controlling application behavior when external clients have references to the application's objects. Besides maintaining a count of references to each object, servers maintain a global count of active objects. The global functions [AfxOleLockApp](../mfc/reference/application-control.md#afxolelockapp) and [AfxOleUnlockApp](../mfc/reference/application-control.md#afxoleunlockapp) update the application's count of active objects. If this count is nonzero, the application does not terminate when the user chooses Close from the system menu or Exit from the File menu. Instead, the application's main window is hidden (but not destroyed) until all pending client requests have been completed. Typically, `AfxOleLockApp` and `AfxOleUnlockApp` are called in the constructors and destructors, respectively, of classes that support Automation.  \n  \n Sometimes circumstances force the server to terminate while a client still has a reference to an object. For example, a resource on which the server depends may become unavailable, causing the server to encounter an error. The user may also close a server document that contains objects to which other applications have references.  \n  \n In the [!INCLUDE[winSDK](../atl/includes/winsdk_md.md)], see `IUnknown::AddRef` and `IUnknown::Release`.  \n  \n## See Also  \n [Automation Servers](../mfc/automation-servers.md)   \n [AfxOleCanExitApp](../mfc/reference/application-control.md#afxolecanexitapp)\n\n"}