{"nodes":[{"pos":[12,50],"content":"Cleaning up Resources | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Cleaning up Resources | Microsoft Docs","pos":[0,38]}]},{"content":"Cleaning up Resources","pos":[838,859]},{"content":"During termination-handler execution, you may not know which resources are actually allocated before the termination handler was called.","pos":[860,996]},{"content":"It is possible that the <ph id=\"ph1\">`__try`</ph> statement block was interrupted before all resources were allocated, so that not all resources were opened.","pos":[997,1136],"source":" It is possible that the `__try` statement block was interrupted before all resources were allocated, so that not all resources were opened."},{"content":"Therefore, to be safe, you should check to see which resources are actually open before proceeding with termination-handling cleanup.","pos":[1143,1276]},{"content":"A recommended procedure is to:","pos":[1277,1307]},{"content":"Initialize handles to NULL.","pos":[1317,1344]},{"content":"In the <ph id=\"ph1\">`__try`</ph> statement block, allocate resources.","pos":[1354,1405],"source":"In the `__try` statement block, allocate resources."},{"content":"Handles are set to positive values as the resource is allocated.","pos":[1406,1470]},{"pos":[1480,1605],"content":"In the <ph id=\"ph1\">`__finally`</ph> statement block, release each resource whose corresponding handle or flag variable is nonzero or not NULL.","source":"In the `__finally` statement block, release each resource whose corresponding handle or flag variable is nonzero or not NULL."},{"content":"Example","pos":[1614,1621]},{"content":"For example, the following code uses a termination handler to close three files and a memory block that were allocated in the <ph id=\"ph1\">`__try`</ph> statement block.","pos":[1625,1775],"source":"For example, the following code uses a termination handler to close three files and a memory block that were allocated in the `__try` statement block."},{"content":"Before cleaning up a resource, the code first checks to see if the resource was allocated.","pos":[1776,1866]},{"content":"See Also","pos":[2618,2626]},{"content":"Writing a Termination Handler","pos":[2631,2660]},{"content":"Structured Exception Handling (C/C++)","pos":[2708,2745]}],"content":"---\ntitle: \"Cleaning up Resources | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"language-reference\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"termination handlers, cleaning up resources\"\n  - \"exception handling, cleaning up resources\"\n  - \"C++ exception handling, termination handlers\"\n  - \"resources [C++], cleaning up\"\n  - \"exception handling, cleanup code\"\n  - \"try-catch keyword [C++], termination handlers\"\nms.assetid: 65753efe-6a27-4750-b90c-50635775c1b6\ncaps.latest.revision: 8\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Cleaning up Resources\nDuring termination-handler execution, you may not know which resources are actually allocated before the termination handler was called. It is possible that the `__try` statement block was interrupted before all resources were allocated, so that not all resources were opened.  \n  \n Therefore, to be safe, you should check to see which resources are actually open before proceeding with termination-handling cleanup. A recommended procedure is to:  \n  \n1.  Initialize handles to NULL.  \n  \n2.  In the `__try` statement block, allocate resources. Handles are set to positive values as the resource is allocated.  \n  \n3.  In the `__finally` statement block, release each resource whose corresponding handle or flag variable is nonzero or not NULL.  \n  \n## Example  \n For example, the following code uses a termination handler to close three files and a memory block that were allocated in the `__try` statement block. Before cleaning up a resource, the code first checks to see if the resource was allocated.  \n  \n```  \n// exceptions_Cleaning_up_Resources.cpp  \n#include <stdlib.h>  \n#include <malloc.h>  \n#include <stdio.h>  \n#include <windows.h>  \n  \nvoid fileOps() {  \n   FILE  *fp1 = NULL,  \n         *fp2 = NULL,  \n         *fp3 = NULL;  \n   LPVOID lpvoid = NULL;  \n   errno_t err;  \n  \n   __try {  \n      lpvoid = malloc( BUFSIZ );  \n  \n      err = fopen_s(&fp1, \"ADDRESS.DAT\", \"w+\" );  \n      err = fopen_s(&fp2, \"NAMES.DAT\", \"w+\" );  \n      err = fopen_s(&fp3, \"CARS.DAT\", \"w+\" );  \n   }  \n   __finally {  \n      if ( fp1 )  \n         fclose( fp1 );  \n      if ( fp2 )  \n         fclose( fp2 );  \n      if ( fp3 )  \n         fclose( fp3 );  \n      if ( lpvoid )  \n         free( lpvoid );  \n   }  \n}  \n  \nint main() {  \n   fileOps();  \n}  \n```  \n  \n## See Also  \n [Writing a Termination Handler](../cpp/writing-a-termination-handler.md)   \n [Structured Exception Handling (C/C++)](../cpp/structured-exception-handling-c-cpp.md)"}