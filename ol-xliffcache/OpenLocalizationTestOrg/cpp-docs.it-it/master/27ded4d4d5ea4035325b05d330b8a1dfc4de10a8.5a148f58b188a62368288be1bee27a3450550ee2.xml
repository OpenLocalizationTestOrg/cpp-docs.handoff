{"nodes":[{"pos":[12,57],"content":"Unloading a Delay-Loaded DLL | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"Unloading a Delay-Loaded DLL | Microsoft Docs","pos":[0,45]}]},{"content":"Unloading a Delay-Loaded DLL","pos":[631,659]},{"content":"The default-supplied delay-load helper checks to see if the delay-load descriptors have a pointer and a copy of the original import address table (IAT) in the pUnloadIAT field.","pos":[660,836]},{"content":"If so, it will save a pointer in a list to the import delay descriptor.","pos":[837,908]},{"content":"This enables the helper function to find the DLL by name to support unloading that DLL explicitly.","pos":[909,1007]},{"content":"Here are the associated structures and functions for explicitly unloading a delay-loaded DLL:","pos":[1014,1107]},{"content":"The UnloadInfo structure is implemented using a C++ class that uses <bpt id=\"p1\">**</bpt>LocalAlloc<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>LocalFree<ept id=\"p2\">**</ept> implementations as its operator <bpt id=\"p3\">**</bpt>new<ept id=\"p3\">**</ept> and operator <bpt id=\"p4\">**</bpt>delete<ept id=\"p4\">**</ept> respectively.","pos":[1698,1876],"source":"The UnloadInfo structure is implemented using a C++ class that uses **LocalAlloc** and **LocalFree** implementations as its operator **new** and operator **delete** respectively."},{"content":"These options are kept in a standard linked list using __puiHead as the head of the list.","pos":[1877,1966]},{"content":"Calling __FUnloadDelayLoadedDLL will attempt to find the name you provide in the list of loaded DLLs (an exact match is required).","pos":[1973,2103]},{"content":"If found, the copy of the IAT in pUnloadIAT is copied over the top of the running IAT to restore the thunk pointers, the library is freed with <bpt id=\"p1\">**</bpt>FreeLibrary<ept id=\"p1\">**</ept>, the matching <bpt id=\"p2\">**</bpt>UnloadInfo<ept id=\"p2\">**</ept> record is unlinked from the list and deleted, and TRUE is returned.","pos":[2104,2359],"source":" If found, the copy of the IAT in pUnloadIAT is copied over the top of the running IAT to restore the thunk pointers, the library is freed with **FreeLibrary**, the matching **UnloadInfo** record is unlinked from the list and deleted, and TRUE is returned."},{"content":"The argument to the function __FUnloadDelayLoadedDLL2 is case sensitive.","pos":[2366,2438]},{"content":"For example, you would specify:","pos":[2439,2470]},{"content":"and not:","pos":[2534,2542]},{"content":"See Also","pos":[2609,2617]},{"content":"Understanding the Helper Function","pos":[2622,2655]}],"content":"---\ntitle: \"Unloading a Delay-Loaded DLL | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"__FUnloadDelayLoadedDLL2\"\n  - \"delayed loading of DLLs, unloading\"\nms.assetid: 6463bc71-020e-4aff-a4ca-90360411c54e\ncaps.latest.revision: 7\nauthor: \"corob-msft\"\nms.author: \"corob\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# Unloading a Delay-Loaded DLL\nThe default-supplied delay-load helper checks to see if the delay-load descriptors have a pointer and a copy of the original import address table (IAT) in the pUnloadIAT field. If so, it will save a pointer in a list to the import delay descriptor. This enables the helper function to find the DLL by name to support unloading that DLL explicitly.  \n  \n Here are the associated structures and functions for explicitly unloading a delay-loaded DLL:  \n  \n```  \n//  \n// Unload support from delayimp.h  \n//  \n  \n// routine definition; takes a pointer to a name to unload  \n  \nExternC  \nBOOL WINAPI  \n__FUnloadDelayLoadedDLL2(LPCSTR szDll);  \n  \n// structure definitions for the list of unload records  \ntypedef struct UnloadInfo * PUnloadInfo;  \ntypedef struct UnloadInfo {  \n    PUnloadInfo     puiNext;  \n    PCImgDelayDescr pidd;  \n    } UnloadInfo;  \n  \n// from delayhlp.cpp  \n// the default delay load helper places the unloadinfo records in the   \n// list headed by the following pointer.  \nExternC  \nPUnloadInfo __puiHead;  \n```  \n  \n The UnloadInfo structure is implemented using a C++ class that uses **LocalAlloc** and **LocalFree** implementations as its operator **new** and operator **delete** respectively. These options are kept in a standard linked list using __puiHead as the head of the list.  \n  \n Calling __FUnloadDelayLoadedDLL will attempt to find the name you provide in the list of loaded DLLs (an exact match is required). If found, the copy of the IAT in pUnloadIAT is copied over the top of the running IAT to restore the thunk pointers, the library is freed with **FreeLibrary**, the matching **UnloadInfo** record is unlinked from the list and deleted, and TRUE is returned.  \n  \n The argument to the function __FUnloadDelayLoadedDLL2 is case sensitive. For example, you would specify:  \n  \n```  \n__FUnloadDelayLoadedDLL2(\"user32.DLL\");  \n```  \n  \n and not:  \n  \n```  \n__FUnloadDelayLoadedDLL2(\"User32.DLL\");.  \n```  \n  \n## See Also  \n [Understanding the Helper Function](http://msdn.microsoft.com/en-us/6279c12c-d908-4967-b0b3-cabfc3e91d3d)"}