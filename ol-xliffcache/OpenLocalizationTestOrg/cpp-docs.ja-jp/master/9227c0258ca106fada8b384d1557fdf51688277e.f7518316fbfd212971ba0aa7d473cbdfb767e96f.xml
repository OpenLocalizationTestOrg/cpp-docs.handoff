{"nodes":[{"pos":[12,82],"content":"How to: Marshal Unicode Strings for ADO.NET (C++-CLI) | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"How to: Marshal Unicode Strings for ADO.NET (C++-CLI) | Microsoft Docs","pos":[0,70]}]},{"content":"How to: Marshal Unicode Strings for ADO.NET (C++/CLI)","pos":[703,756]},{"pos":[757,943],"content":"Demonstrates how to add a native Unicode string (<ph id=\"ph1\">`wchar_t *`</ph>) to a database and how to marshal a &lt;xref:System.String?displayProperty=fullName&gt; from a database to a native Unicode string.","source":"Demonstrates how to add a native Unicode string (`wchar_t *`) to a database and how to marshal a <xref:System.String?displayProperty=fullName> from a database to a native Unicode string."},{"content":"Example","pos":[952,959]},{"content":"In this example, the class DatabaseClass is created to interact with an ADO.NET &lt;xref:System.Data.DataTable&gt; object.","pos":[963,1079],"source":"In this example, the class DatabaseClass is created to interact with an ADO.NET <xref:System.Data.DataTable> object."},{"content":"Note that this class is a native C++ <ph id=\"ph1\">`class`</ph> (as compared to a <ph id=\"ph2\">`ref class`</ph> or <ph id=\"ph3\">`value class`</ph>).","pos":[1080,1173],"source":" Note that this class is a native C++ `class` (as compared to a `ref class` or `value class`)."},{"content":"This is necessary because we want to use this class from native code, and you cannot use managed types in native code.","pos":[1174,1292]},{"content":"This class will be compiled to target the CLR, as is indicated by the <ph id=\"ph1\">`#pragma managed`</ph> directive preceding the class declaration.","pos":[1293,1423],"source":" This class will be compiled to target the CLR, as is indicated by the `#pragma managed` directive preceding the class declaration."},{"content":"For more information on this directive, see <bpt id=\"p1\">[</bpt>managed, unmanaged<ept id=\"p1\">](../preprocessor/managed-unmanaged.md)</ept>.","pos":[1424,1527],"source":" For more information on this directive, see [managed, unmanaged](../preprocessor/managed-unmanaged.md)."},{"content":"Note the private member of the DatabaseClass class: <ph id=\"ph1\">`gcroot&lt;DataTable ^&gt; table`</ph>.","pos":[1534,1614],"source":"Note the private member of the DatabaseClass class: `gcroot<DataTable ^> table`."},{"content":"Since native types cannot contain managed types, the <ph id=\"ph1\">`gcroot`</ph> keyword is necessary.","pos":[1615,1698],"source":" Since native types cannot contain managed types, the `gcroot` keyword is necessary."},{"content":"For more information on <ph id=\"ph1\">`gcroot`</ph>, see <bpt id=\"p1\">[</bpt>How to: Declare Handles in Native Types<ept id=\"p1\">](../dotnet/how-to-declare-handles-in-native-types.md)</ept>.","pos":[1699,1832],"source":" For more information on `gcroot`, see [How to: Declare Handles in Native Types](../dotnet/how-to-declare-handles-in-native-types.md)."},{"content":"The rest of the code in this example is native C++ code, as is indicated by the <ph id=\"ph1\">`#pragma unmanaged`</ph> directive preceding <ph id=\"ph2\">`main`</ph>.","pos":[1839,1966],"source":"The rest of the code in this example is native C++ code, as is indicated by the `#pragma unmanaged` directive preceding `main`."},{"content":"In this example, we are creating a new instance of DatabaseClass and calling its methods to create a table and populate some rows in the table.","pos":[1967,2110]},{"content":"Note that Unicode C++ strings are being passed as values for the database column StringCol.","pos":[2111,2202]},{"content":"Inside DatabaseClass, these strings are marshaled to managed strings using the marshaling functionality found in the &lt;xref:System.Runtime.InteropServices?displayProperty=fullName&gt; namespace.","pos":[2203,2393],"source":" Inside DatabaseClass, these strings are marshaled to managed strings using the marshaling functionality found in the <xref:System.Runtime.InteropServices?displayProperty=fullName> namespace."},{"content":"Specifically, the method &lt;xref:System.Runtime.InteropServices.Marshal.PtrToStringUni%2A&gt; is used to marshal a <ph id=\"ph1\">`wchar_t *`</ph> to a &lt;xref:System.String&gt;, and the method &lt;xref:System.Runtime.InteropServices.Marshal.StringToHGlobalUni%2A&gt; is used to marshal a &lt;xref:System.String&gt; to a <ph id=\"ph2\">`wchar_t *`</ph>.","pos":[2394,2685],"source":" Specifically, the method <xref:System.Runtime.InteropServices.Marshal.PtrToStringUni%2A> is used to marshal a `wchar_t *` to a <xref:System.String>, and the method <xref:System.Runtime.InteropServices.Marshal.StringToHGlobalUni%2A> is used to marshal a <xref:System.String> to a `wchar_t *`."},{"pos":[2693,2911],"content":"[!NOTE]\n The memory allocated by <xref:System.Runtime.InteropServices.Marshal.StringToHGlobalUni%2A> must be deallocated by calling either <xref:System.Runtime.InteropServices.Marshal.FreeHGlobal%2A> or `GlobalFree`.","leadings":["","> "],"nodes":[{"content":"The memory allocated by &lt;xref:System.Runtime.InteropServices.Marshal.StringToHGlobalUni%2A&gt; must be deallocated by calling either &lt;xref:System.Runtime.InteropServices.Marshal.FreeHGlobal%2A&gt; or <ph id=\"ph1\">`GlobalFree`</ph>.","pos":[9,216],"source":" The memory allocated by <xref:System.Runtime.InteropServices.Marshal.StringToHGlobalUni%2A> must be deallocated by calling either <xref:System.Runtime.InteropServices.Marshal.FreeHGlobal%2A> or `GlobalFree`."}]},{"content":"Compiling the Code","pos":[5732,5750]},{"content":"To compile the code from the command line, save the code example in a file named adonet_marshal_string_wide.cpp and enter the following statement:","pos":[5760,5906]},{"content":".NET Framework Security","pos":[6037,6060]},{"pos":[6064,6226],"content":"For information on security issues involving ADO.NET, see <bpt id=\"p1\">[</bpt>Securing ADO.NET Applications<ept id=\"p1\">](http://msdn.microsoft.com/Library/005a1d43-6ee5-471e-ad98-1d30a44d49d5)</ept>.","source":"For information on security issues involving ADO.NET, see [Securing ADO.NET Applications](http://msdn.microsoft.com/Library/005a1d43-6ee5-471e-ad98-1d30a44d49d5)."},{"content":"See Also","pos":[6235,6243]},{"content":"&lt;xref:System.Runtime.InteropServices&gt;","pos":[6247,6284],"source":"<xref:System.Runtime.InteropServices> "},{"content":"Data Access Using ADO.NET (C++/CLI)","pos":[6290,6325]},{"content":"ADO.NET","pos":[6379,6386]},{"content":"Interoperability","pos":[6465,6481]},{"content":"Native and .NET Interoperability","pos":[6558,6590]}],"content":"---\ntitle: \"How to: Marshal Unicode Strings for ADO.NET (C++-CLI) | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"get-started-article\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"ADO.NET [C++], marshaling Unicode strings\"\n  - \"Unicode [C++], strings\"\n  - \"strings [C++], Unicode\"\nms.assetid: 1da090ff-6b53-40be-841f-dc79dfe8ba10\ncaps.latest.revision: 11\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"cs-cz\"\n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"ru-ru\"\n  - \"tr-tr\"\n  - \"zh-cn\"\n  - \"zh-tw\"\n---\n# How to: Marshal Unicode Strings for ADO.NET (C++/CLI)\nDemonstrates how to add a native Unicode string (`wchar_t *`) to a database and how to marshal a <xref:System.String?displayProperty=fullName> from a database to a native Unicode string.  \n  \n## Example  \n In this example, the class DatabaseClass is created to interact with an ADO.NET <xref:System.Data.DataTable> object. Note that this class is a native C++ `class` (as compared to a `ref class` or `value class`). This is necessary because we want to use this class from native code, and you cannot use managed types in native code. This class will be compiled to target the CLR, as is indicated by the `#pragma managed` directive preceding the class declaration. For more information on this directive, see [managed, unmanaged](../preprocessor/managed-unmanaged.md).  \n  \n Note the private member of the DatabaseClass class: `gcroot<DataTable ^> table`. Since native types cannot contain managed types, the `gcroot` keyword is necessary. For more information on `gcroot`, see [How to: Declare Handles in Native Types](../dotnet/how-to-declare-handles-in-native-types.md).  \n  \n The rest of the code in this example is native C++ code, as is indicated by the `#pragma unmanaged` directive preceding `main`. In this example, we are creating a new instance of DatabaseClass and calling its methods to create a table and populate some rows in the table. Note that Unicode C++ strings are being passed as values for the database column StringCol. Inside DatabaseClass, these strings are marshaled to managed strings using the marshaling functionality found in the <xref:System.Runtime.InteropServices?displayProperty=fullName> namespace. Specifically, the method <xref:System.Runtime.InteropServices.Marshal.PtrToStringUni%2A> is used to marshal a `wchar_t *` to a <xref:System.String>, and the method <xref:System.Runtime.InteropServices.Marshal.StringToHGlobalUni%2A> is used to marshal a <xref:System.String> to a `wchar_t *`.  \n  \n> [!NOTE]\n>  The memory allocated by <xref:System.Runtime.InteropServices.Marshal.StringToHGlobalUni%2A> must be deallocated by calling either <xref:System.Runtime.InteropServices.Marshal.FreeHGlobal%2A> or `GlobalFree`.  \n  \n```  \n// adonet_marshal_string_wide.cpp  \n// compile with: /clr /FU System.dll /FU System.Data.dll /FU System.Xml.dll  \n#include <comdef.h>  \n#include <gcroot.h>  \n#include <iostream>  \nusing namespace std;  \n  \n#using <System.Data.dll>  \nusing namespace System;  \nusing namespace System::Data;  \nusing namespace System::Runtime::InteropServices;  \n  \n#define MAXCOLS 100  \n  \n#pragma managed  \nclass DatabaseClass  \n{  \npublic:  \n    DatabaseClass() : table(nullptr) { }  \n  \n    void AddRow(wchar_t *stringColValue)  \n    {  \n        // Add a row to the table.  \n        DataRow ^row = table->NewRow();  \n        row[\"StringCol\"] = Marshal::PtrToStringUni(  \n            (IntPtr)stringColValue);  \n        table->Rows->Add(row);  \n    }  \n  \n    void CreateAndPopulateTable()  \n    {  \n        // Create a simple DataTable.  \n        table = gcnew DataTable(\"SampleTable\");  \n  \n        // Add a column of type String to the table.  \n        DataColumn ^column1 = gcnew DataColumn(\"StringCol\",  \n            Type::GetType(\"System.String\"));  \n        table->Columns->Add(column1);  \n    }  \n  \n    int GetValuesForColumn(wchar_t *dataColumn, wchar_t **values,  \n        int valuesLength)  \n    {  \n        // Marshal the name of the column to a managed  \n        // String.  \n        String ^columnStr = Marshal::PtrToStringUni(  \n                (IntPtr)dataColumn);  \n  \n        // Get all rows in the table.  \n        array<DataRow ^> ^rows = table->Select();  \n        int len = rows->Length;  \n        len = (len > valuesLength) ? valuesLength : len;  \n        for (int i = 0; i < len; i++)  \n        {  \n            // Marshal each column value from a managed string  \n            // to a wchar_t *.  \n            values[i] = (wchar_t *)Marshal::StringToHGlobalUni(  \n                (String ^)rows[i][columnStr]).ToPointer();  \n        }  \n  \n        return len;  \n    }  \n  \nprivate:  \n    // Using gcroot, you can use a managed type in  \n    // a native class.  \n    gcroot<DataTable ^> table;  \n};  \n  \n#pragma unmanaged  \nint main()  \n{  \n    // Create a table and add a few rows to it.  \n    DatabaseClass *db = new DatabaseClass();  \n    db->CreateAndPopulateTable();  \n    db->AddRow(L\"This is string 1.\");  \n    db->AddRow(L\"This is string 2.\");  \n  \n    // Now retrieve the rows and display their contents.  \n    wchar_t *values[MAXCOLS];  \n    int len = db->GetValuesForColumn(  \n        L\"StringCol\", values, MAXCOLS);  \n    for (int i = 0; i < len; i++)  \n    {  \n        wcout << \"StringCol: \" << values[i] << endl;  \n  \n        // Deallocate the memory allocated using  \n        // Marshal::StringToHGlobalUni.  \n        GlobalFree(values[i]);  \n    }  \n  \n    delete db;  \n  \n    return 0;  \n}  \n```  \n  \n```Output  \nStringCol: This is string 1.  \nStringCol: This is string 2.  \n```  \n  \n## Compiling the Code  \n  \n-   To compile the code from the command line, save the code example in a file named adonet_marshal_string_wide.cpp and enter the following statement:  \n  \n    ```  \n    cl /clr /FU System.dll /FU System.Data.dll /FU System.Xml.dll adonet_marshal_string_wide.cpp  \n    ```  \n  \n## .NET Framework Security  \n For information on security issues involving ADO.NET, see [Securing ADO.NET Applications](http://msdn.microsoft.com/Library/005a1d43-6ee5-471e-ad98-1d30a44d49d5).  \n  \n## See Also  \n <xref:System.Runtime.InteropServices>   \n [Data Access Using ADO.NET (C++/CLI)](../dotnet/data-access-using-adonet-cpp-cli.md)   \n [ADO.NET](http://msdn.microsoft.com/Library/5b96ed06-9759-4966-a797-a1d5f6ee50ca)   \n [Interoperability](http://msdn.microsoft.com/en-us/afcc2e7d-3f32-48d2-8141-1c42acf29084)   \n [Native and .NET Interoperability](../dotnet/native-and-dotnet-interoperability.md)"}