{"nodes":[{"pos":[12,113],"content":"How to: Convert an OpenMP Loop that Uses Cancellation to Use the Concurrency Runtime | Microsoft Docs","needQuote":false,"needEscape":true,"nodes":[{"content":"How to: Convert an OpenMP Loop that Uses Cancellation to Use the Concurrency Runtime | Microsoft Docs","pos":[0,101]}]},{"content":"How to: Convert an OpenMP Loop that Uses Cancellation to Use the Concurrency Runtime","pos":[782,866]},{"content":"Some parallel loops do not require that all iterations be executed.","pos":[867,934]},{"content":"For example, an algorithm that searches for a value can terminate after the value is found.","pos":[935,1026]},{"content":"OpenMP does not provide a mechanism to break out of a parallel loop.","pos":[1027,1095]},{"content":"However, you can use a Boolean value, or flag, to enable an iteration of the loop to indicate that the solution has been found.","pos":[1096,1223]},{"content":"The Concurrency Runtime provides functionality that enables one task to cancel other tasks that have not yet started.","pos":[1224,1341]},{"pos":[1348,1664],"content":"This example demonstrates how to convert an OpenMP <bpt id=\"p1\">[</bpt>parallel<ept id=\"p1\">](../../parallel/concrt/how-to-use-parallel-invoke-to-write-a-parallel-sort-routine.md#parallel)</ept><bpt id=\"p2\">[</bpt>for<ept id=\"p2\">](../../parallel/openmp/reference/for-openmp.md)</ept> loop that does not require for all iterations to run to use the Concurrency Runtime cancellation mechanism.","source":"This example demonstrates how to convert an OpenMP [parallel](../../parallel/concrt/how-to-use-parallel-invoke-to-write-a-parallel-sort-routine.md#parallel)[for](../../parallel/openmp/reference/for-openmp.md) loop that does not require for all iterations to run to use the Concurrency Runtime cancellation mechanism."},{"content":"Example","pos":[1673,1680]},{"content":"This example uses both OpenMP and the Concurrency Runtime to implement a parallel version of the <bpt id=\"p1\">[</bpt>std::any_of<ept id=\"p1\">](http://msdn.microsoft.com/library/c0a685f6-8242-42c6-b1bc-3956d25ae535)</ept> algorithm.","pos":[1685,1878],"source":"This example uses both OpenMP and the Concurrency Runtime to implement a parallel version of the [std::any_of](http://msdn.microsoft.com/library/c0a685f6-8242-42c6-b1bc-3956d25ae535) algorithm."},{"content":"The OpenMP version of this example uses a flag to coordinate among all parallel loop iterations that the condition has been met.","pos":[1879,2007]},{"content":"The version that uses the Concurrency Runtime uses the <bpt id=\"p1\">[</bpt>concurrency::structured_task_group::cancel<ept id=\"p1\">](reference/structured-task-group-class.md#cancel)</ept> method to stop the overall operation when the condition is met.","pos":[2008,2220],"source":" The version that uses the Concurrency Runtime uses the [concurrency::structured_task_group::cancel](reference/structured-task-group-class.md#cancel) method to stop the overall operation when the condition is met."},{"pos":[2239,2254],"content":"concrt-openmp#2"},{"content":"This example produces the following output.","pos":[2354,2397]},{"content":"In the version of that uses OpenMP, all iterations of the loop execute, even when the flag is set.","pos":[2532,2630]},{"content":"Furthermore, if a task were to have any child tasks, the flag would also have to be available to those child tasks to communicate cancellation.","pos":[2631,2774]},{"content":"In the Concurrency Runtime, when a task group is cancelled, the runtime cancels the entire tree of work, including child tasks.","pos":[2775,2902]},{"content":"The <bpt id=\"p1\">[</bpt>concurrency::parallel_for_each<ept id=\"p1\">](reference/concurrency-namespace-functions.md#parallel_for_each)</ept> algorithm uses tasks to perform work.","pos":[2903,3041],"source":" The [concurrency::parallel_for_each](reference/concurrency-namespace-functions.md#parallel_for_each) algorithm uses tasks to perform work."},{"content":"Therefore, when one iteration of the loop cancels the root task, the entire tree of computation is also cancelled.","pos":[3042,3156]},{"content":"When a tree of work is cancelled, the runtime does not start new tasks.","pos":[3157,3228]},{"content":"However, the runtime allows tasks that have already started to finish.","pos":[3229,3299]},{"content":"Therefore, in the case of the <ph id=\"ph1\">`parallel_for_each`</ph> algorithm, active loop iterations can clean up their resources.","pos":[3300,3413],"source":" Therefore, in the case of the `parallel_for_each` algorithm, active loop iterations can clean up their resources."},{"content":"In both versions of this example, if the array contains more than one copy of the value to search for, multiple loop iterations can each simultaneously set the result and cancel the overall operation.","pos":[3420,3620]},{"content":"You can use a synchronization primitive, such as a critical section, if your problem requires that only one task performs work when a condition is met.","pos":[3621,3772]},{"content":"You can also use exception handling to cancel tasks that use the PPL.","pos":[3779,3848]},{"content":"For more information about cancellation, see <bpt id=\"p1\">[</bpt>Cancellation in the PPL<ept id=\"p1\">](cancellation-in-the-ppl.md)</ept>.","pos":[3849,3948],"source":" For more information about cancellation, see [Cancellation in the PPL](cancellation-in-the-ppl.md)."},{"pos":[3955,4105],"content":"For more information about <ph id=\"ph1\">`parallel_for_each`</ph> and other parallel algorithms, see <bpt id=\"p1\">[</bpt>Parallel Algorithms<ept id=\"p1\">](../../parallel/concrt/parallel-algorithms.md)</ept>.","source":"For more information about `parallel_for_each` and other parallel algorithms, see [Parallel Algorithms](../../parallel/concrt/parallel-algorithms.md)."},{"content":"Compiling the Code","pos":[4114,4132]},{"pos":[4136,4344],"content":"Copy the example code and paste it in a Visual Studio project, or paste it in a file that is named <ph id=\"ph1\">`concrt-omp-parallel-any-of.cpp`</ph> and then run the following command in a Visual Studio Command Prompt window.","source":"Copy the example code and paste it in a Visual Studio project, or paste it in a file that is named `concrt-omp-parallel-any-of.cpp` and then run the following command in a Visual Studio Command Prompt window."},{"content":"cl.exe /EHsc /openmp concrt-omp-parallel-any-of.cpp","pos":[4353,4404]},{"content":"See Also","pos":[4415,4423]},{"content":"Migrating from OpenMP to the Concurrency Runtime","pos":[4428,4476]},{"content":"Cancellation in the PPL","pos":[4558,4581]},{"content":"Parallel Algorithms","pos":[4616,4635]}],"content":"---\ntitle: \"How to: Convert an OpenMP Loop that Uses Cancellation to Use the Concurrency Runtime | Microsoft Docs\"\nms.custom: \"\"\nms.date: \"11/04/2016\"\nms.reviewer: \"\"\nms.suite: \"\"\nms.technology: \n  - \"devlang-cpp\"\nms.tgt_pltfrm: \"\"\nms.topic: \"article\"\ndev_langs: \n  - \"C++\"\nhelpviewer_keywords: \n  - \"converting from OpenMP to the Concurrency Runtime, cancellation\"\n  - \"cancellation, converting from OpenMP to the Concurrency Runtime\"\nms.assetid: 4b0b3c33-bfa9-4e96-ae08-aef245a39cbb\ncaps.latest.revision: 11\nauthor: \"mikeblome\"\nms.author: \"mblome\"\nmanager: \"ghogen\"\ntranslation.priority.ht: \n  - \"de-de\"\n  - \"es-es\"\n  - \"fr-fr\"\n  - \"it-it\"\n  - \"ja-jp\"\n  - \"ko-kr\"\n  - \"ru-ru\"\n  - \"zh-cn\"\n  - \"zh-tw\"\ntranslation.priority.mt: \n  - \"cs-cz\"\n  - \"pl-pl\"\n  - \"pt-br\"\n  - \"tr-tr\"\n---\n# How to: Convert an OpenMP Loop that Uses Cancellation to Use the Concurrency Runtime\nSome parallel loops do not require that all iterations be executed. For example, an algorithm that searches for a value can terminate after the value is found. OpenMP does not provide a mechanism to break out of a parallel loop. However, you can use a Boolean value, or flag, to enable an iteration of the loop to indicate that the solution has been found. The Concurrency Runtime provides functionality that enables one task to cancel other tasks that have not yet started.  \n  \n This example demonstrates how to convert an OpenMP [parallel](../../parallel/concrt/how-to-use-parallel-invoke-to-write-a-parallel-sort-routine.md#parallel)[for](../../parallel/openmp/reference/for-openmp.md) loop that does not require for all iterations to run to use the Concurrency Runtime cancellation mechanism.  \n  \n## Example  \n\n This example uses both OpenMP and the Concurrency Runtime to implement a parallel version of the [std::any_of](http://msdn.microsoft.com/library/c0a685f6-8242-42c6-b1bc-3956d25ae535) algorithm. The OpenMP version of this example uses a flag to coordinate among all parallel loop iterations that the condition has been met. The version that uses the Concurrency Runtime uses the [concurrency::structured_task_group::cancel](reference/structured-task-group-class.md#cancel) method to stop the overall operation when the condition is met.  \n\n  \n [!code-cpp[concrt-openmp#2](../../parallel/concrt/codesnippet/cpp/convert-an-openmp-loop-that-uses-cancellation_1.cpp)]  \n  \n This example produces the following output.  \n  \n```Output  \nUsing OpenMP...  \n9114046 is in the array.  \nUsing the Concurrency Runtime...  \n9114046 is in the array.  \n```  \n  \n In the version of that uses OpenMP, all iterations of the loop execute, even when the flag is set. Furthermore, if a task were to have any child tasks, the flag would also have to be available to those child tasks to communicate cancellation. In the Concurrency Runtime, when a task group is cancelled, the runtime cancels the entire tree of work, including child tasks. The [concurrency::parallel_for_each](reference/concurrency-namespace-functions.md#parallel_for_each) algorithm uses tasks to perform work. Therefore, when one iteration of the loop cancels the root task, the entire tree of computation is also cancelled. When a tree of work is cancelled, the runtime does not start new tasks. However, the runtime allows tasks that have already started to finish. Therefore, in the case of the `parallel_for_each` algorithm, active loop iterations can clean up their resources.  \n  \n In both versions of this example, if the array contains more than one copy of the value to search for, multiple loop iterations can each simultaneously set the result and cancel the overall operation. You can use a synchronization primitive, such as a critical section, if your problem requires that only one task performs work when a condition is met.  \n  \n You can also use exception handling to cancel tasks that use the PPL. For more information about cancellation, see [Cancellation in the PPL](cancellation-in-the-ppl.md).  \n  \n For more information about `parallel_for_each` and other parallel algorithms, see [Parallel Algorithms](../../parallel/concrt/parallel-algorithms.md).  \n  \n## Compiling the Code  \n Copy the example code and paste it in a Visual Studio project, or paste it in a file that is named `concrt-omp-parallel-any-of.cpp` and then run the following command in a Visual Studio Command Prompt window.  \n  \n **cl.exe /EHsc /openmp concrt-omp-parallel-any-of.cpp**  \n  \n## See Also  \n [Migrating from OpenMP to the Concurrency Runtime](../../parallel/concrt/migrating-from-openmp-to-the-concurrency-runtime.md)   \n [Cancellation in the PPL](cancellation-in-the-ppl.md)   \n [Parallel Algorithms](../../parallel/concrt/parallel-algorithms.md)\n\n"}